---
title: Day07-13åˆ°19ã€Šè´­ç‰©è½¦åŠŸèƒ½ã€‹
tags: [ä¸€åˆ·è‹ç©¹å¤–å–]
date: 2026-01-29
---

# ğŸ¥ Day07-06åˆ°12 è´­ç‰©è½¦æ¨¡å—

### ğŸ§© æœ¬èŠ‚æ¦‚è¿°
> **ä¸€å¥è¯æ€»ç»“**ï¼š  

**ä¸»è¦å†…å®¹å…³é”®è¯**ï¼š`ç±»å1`ã€`ç±»å2`ã€`æŠ€æœ¯ç‚¹1`

---

## ğŸ›’ è´­ç‰©è½¦æ¨¡å— - å…¨æ™¯å›¾

### ğŸ“ ä»£ç æ¿å—åˆ†å¸ƒ

```mermaid
flowchart TB
    subgraph è¡¨ç°å±‚-Controller
        A[ShoppingCartController.java<br/>å¤„ç†HTTPè¯·æ±‚]
    end
    
    subgraph ä¸šåŠ¡å±‚-Service
        B1[ShoppingCartService.java<br/>æ¥å£å®šä¹‰]
        B2[ShoppingCartServiceImpl.java<br/>æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ â­]
    end
    
    subgraph æŒä¹…å±‚-Mapper
        C1[ShoppingCartMapper.java<br/>æ¥å£å®šä¹‰]
        C2[ShoppingCartMapper.xml<br/>SQLè¯­å¥]
    end
    
    subgraph å®ä½“å±‚-POJO
        D1[ShoppingCart.java<br/>æ•°æ®åº“å®ä½“]
        D2[ShoppingCartDTO.java<br/>å‰ç«¯ä¼ å…¥å‚æ•°]
    end
    
    subgraph æ•°æ®åº“
        E[(shopping_cartè¡¨)]
    end
    
    A --> B1 --> B2
    B2 --> C1 --> C2
    C2 --> E
    D1 & D2 -.è¢«ä½¿ç”¨.-> B2
```

---

## ğŸ¯ å››å¤§æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | æ¥å£è·¯å¾„ | HTTPæ–¹æ³• | ä¸šåŠ¡æè¿° |
|-----|---------|---------|---------|
| **æ·»åŠ è´­ç‰©è½¦** | `/user/shoppingCart/add` | POST | åŠ èœå“æˆ–å¥—é¤åˆ°è´­ç‰©è½¦ |
| **æŸ¥çœ‹è´­ç‰©è½¦** | `/user/shoppingCart/list` | GET | æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„è´­ç‰©è½¦ |
| **å‡å°‘å•†å“** | `/user/shoppingCart/sub` | POST | å•†å“æ•°é‡-1æˆ–åˆ é™¤ |
| **æ¸…ç©ºè´­ç‰©è½¦** | `/user/shoppingCart/clean` | DELETE | ä¸€é”®æ¸…ç©º |

---

## ğŸ”¥ æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆæœ€é‡è¦ï¼‰

### åŠŸèƒ½1ï¼šæ·»åŠ è´­ç‰©è½¦ `addShoppingCart()`

è¿™æ˜¯**æœ€å¤æ‚çš„åŠŸèƒ½**ï¼Œæµç¨‹å›¾å¦‚ä¸‹ï¼š

```mermaid
flowchart TD
    A[ç”¨æˆ·ç‚¹å‡» + å·] --> B[æ¥æ”¶å‚æ•°<br/>èœå“ID/å¥—é¤ID/å£å‘³]
    B --> C[è®¾ç½®å½“å‰ç”¨æˆ·ID<br/>BaseContext.getCurrentId]
    C --> D{è¯¥å•†å“å·²åœ¨è´­ç‰©è½¦ä¸­?}
    
    D -->|âœ… å·²å­˜åœ¨| E[æ•°é‡ + 1]
    E --> F[UPDATE æ›´æ–°æ•°é‡]
    
    D -->|âŒ ä¸å­˜åœ¨| G{æ·»åŠ çš„æ˜¯èœå“è¿˜æ˜¯å¥—é¤?}
    G -->|èœå“ dishId != null| H[æŸ¥è¯¢èœå“ä¿¡æ¯<br/>è·å–åç§°/å›¾ç‰‡/ä»·æ ¼]
    G -->|å¥—é¤ dishId == null| I[æŸ¥è¯¢å¥—é¤ä¿¡æ¯<br/>è·å–åç§°/å›¾ç‰‡/ä»·æ ¼]
    
    H --> J[æ„å»ºè´­ç‰©è½¦å¯¹è±¡<br/>æ•°é‡=1]
    I --> J
    J --> K[INSERT æ’å…¥æ–°è®°å½•]
    
    F --> L[è¿”å›æˆåŠŸ]
    K --> L
    
    style C fill:#FFD700
    style D fill:#87CEEB
```

**å…³é”®è®¾è®¡æ€è€ƒ**ï¼š

| è®¾è®¡ç‚¹ | è¯´æ˜ |
|-------|------|
| **ç”¨æˆ·éš”ç¦»** | é€šè¿‡ `BaseContext.getCurrentId()` è·å–å½“å‰ç”¨æˆ·IDï¼Œä¿è¯æ¯ä¸ªç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±çš„è´­ç‰©è½¦ |
| **èœå“ vs å¥—é¤** | é€šè¿‡åˆ¤æ–­ `dishId` æ˜¯å¦ä¸ºç©ºæ¥åŒºåˆ† |
| **å£å‘³åŒºåˆ†** | åŒä¸€èœå“ä¸åŒå£å‘³æ˜¯**ä¸åŒçš„è´­ç‰©è½¦è®°å½•**ï¼ |

---

### åŠŸèƒ½2ï¼šæŸ¥çœ‹è´­ç‰©è½¦ `showShoppingCart()`

```mermaid
flowchart LR
    A[è·å–å½“å‰ç”¨æˆ·ID] --> B[æŒ‰userIdæŸ¥è¯¢è´­ç‰©è½¦è¡¨]
    B --> C[è¿”å›List]
```

**å°±ä¸€è¡Œä»£ç **ï¼šæŸ¥è¯¢å½“å‰ç”¨æˆ·çš„æ‰€æœ‰è´­ç‰©è½¦è®°å½•ã€‚

---

### åŠŸèƒ½3ï¼šå‡å°‘å•†å“ `subShoppingCart()`

```mermaid
flowchart TD
    A[ç”¨æˆ·ç‚¹å‡» - å·] --> B[æŸ¥è¯¢è¯¥å•†å“åœ¨è´­ç‰©è½¦ä¸­çš„è®°å½•]
    B --> C{å½“å‰æ•°é‡æ˜¯å¤šå°‘?}
    
    C -->|æ•°é‡ = 1| D[DELETE ç›´æ¥åˆ é™¤è®°å½•]
    C -->|æ•°é‡ > 1| E[æ•°é‡ - 1]
    E --> F[UPDATE æ›´æ–°æ•°é‡]
    
    D --> G[è¿”å›æˆåŠŸ]
    F --> G
```

---

### åŠŸèƒ½4ï¼šæ¸…ç©ºè´­ç‰©è½¦ `cleanShoppingCart()`

```mermaid
flowchart LR
    A[è·å–å½“å‰ç”¨æˆ·ID] --> B[DELETE FROM shopping_cart<br/>WHERE user_id = ?]
    B --> C[è¿”å›æˆåŠŸ]
```

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

```sql
shopping_cart è´­ç‰©è½¦è¡¨
â”œâ”€â”€ id              -- ä¸»é”®
â”œâ”€â”€ name            -- å•†å“åç§°ï¼ˆå†—ä½™å­˜å‚¨ï¼Œé¿å…æŸ¥è¯¢ï¼‰
â”œâ”€â”€ user_id         -- ç”¨æˆ·ID â­ å…³é”®å­—æ®µ
â”œâ”€â”€ dish_id         -- èœå“IDï¼ˆäºŒé€‰ä¸€ï¼‰
â”œâ”€â”€ setmeal_id      -- å¥—é¤IDï¼ˆäºŒé€‰ä¸€ï¼‰
â”œâ”€â”€ dish_flavor     -- å£å‘³ï¼ˆå¦‚ï¼šä¸è¾£,å°‘ç³–ï¼‰
â”œâ”€â”€ number          -- æ•°é‡
â”œâ”€â”€ amount          -- å•ä»·
â”œâ”€â”€ image           -- å›¾ç‰‡
â””â”€â”€ create_time     -- åˆ›å»ºæ—¶é—´
```

**è®¾è®¡äº®ç‚¹**ï¼š`name`ã€`image`ã€`amount` æ˜¯**å†—ä½™å­—æ®µ**ï¼Œè¿™æ ·æŸ¥çœ‹è´­ç‰©è½¦æ—¶ä¸éœ€è¦å†å»æŸ¥èœå“è¡¨/å¥—é¤è¡¨ï¼

---

## ğŸ¤ é¢è¯•é«˜é¢‘è€ƒç‚¹

### Q1: ä¸ºä»€ä¹ˆè´­ç‰©è½¦æ•°æ®å­˜åœ¨æ•°æ®åº“è€Œä¸æ˜¯ Redisï¼Ÿ

> **ç­”**ï¼šæœ¬é¡¹ç›®ç”¨æ•°æ®åº“å­˜å‚¨ï¼Œä¼˜ç‚¹æ˜¯**æ•°æ®æŒä¹…åŒ–**ï¼Œç”¨æˆ·å…³é—­å°ç¨‹åºåè´­ç‰©è½¦æ•°æ®ä»åœ¨ã€‚
> 
> **è¿½é—®**ï¼š*"å¦‚æœç”¨ Redis å­˜è´­ç‰©è½¦ä¼šæ€ä¹ˆè®¾è®¡ï¼Ÿ"*
> 
> ğŸ‘‰ ä½¿ç”¨ `Hash` ç»“æ„ï¼š
> - Key: `cart:ç”¨æˆ·ID`
> - Field: `èœå“ID:å£å‘³` æˆ– `å¥—é¤ID`
> - Value: å•†å“æ•°é‡/å•†å“JSON

### Q2: `BaseContext.getCurrentId()` æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ

> **ç­”**ï¼šä½¿ç”¨ **ThreadLocal** å­˜å‚¨å½“å‰ç™»å½•ç”¨æˆ·çš„IDã€‚åœ¨æ‹¦æˆªå™¨ä¸­è§£æJWTåï¼Œå°†ç”¨æˆ·IDå­˜å…¥ThreadLocalï¼Œåç»­ä¸šåŠ¡ä»£ç ç›´æ¥å–ç”¨ã€‚
> 
> ğŸ‘‰ **è¿™æ˜¯é¢è¯•å¿…é—®ç‚¹ï¼** ä½ ä¹‹å‰å­¦è¿‡çš„ JWT + ThreadLocal çŸ¥è¯†å°±ç”¨åœ¨è¿™é‡Œï¼

### Q3: åŒä¸€èœå“ä¸åŒå£å‘³æ€ä¹ˆå¤„ç†ï¼Ÿ

> **ç­”**ï¼šçœ‹ Mapper çš„ `list` æŸ¥è¯¢æ¡ä»¶ï¼š
> ```xml
> <if test="dishFlavor!=null">and dish_flavor=#{dishFlavor}</if>
> ```
> å£å‘³æ˜¯æŸ¥è¯¢æ¡ä»¶ä¹‹ä¸€ï¼Œæ‰€ä»¥"å®«ä¿é¸¡ä¸-ä¸è¾£"å’Œ"å®«ä¿é¸¡ä¸-å¾®è¾£"æ˜¯**ä¸¤æ¡ä¸åŒçš„è®°å½•**ã€‚

### Q4: è´­ç‰©è½¦è¡¨ä¸ºä»€ä¹ˆè¦å†—ä½™å­˜å‚¨ nameã€imageã€amountï¼Ÿ

> **ç­”**ï¼š**ä»¥ç©ºé—´æ¢æ—¶é—´**ï¼
> - å¦‚æœä¸å†—ä½™ï¼šæŸ¥çœ‹è´­ç‰©è½¦æ—¶éœ€è¦ JOIN èœå“è¡¨/å¥—é¤è¡¨ï¼ŒæŸ¥è¯¢æ…¢
> - å†—ä½™åï¼šä¸€æ¡ SQL å°±èƒ½æŸ¥å‡ºæ‰€æœ‰å±•ç¤ºä¿¡æ¯
> 
> **è¿½é—®**ï¼š*"å¦‚æœèœå“æ”¹åäº†æ€ä¹ˆåŠï¼Ÿ"*
> 
> ğŸ‘‰ è´­ç‰©è½¦é‡Œçš„è¿˜æ˜¯æ—§åå­—ï¼Œä½†è¿™ç¬¦åˆä¸šåŠ¡é€»è¾‘ï¼ˆç”¨æˆ·åŠ å…¥è´­ç‰©è½¦æ—¶æ˜¯é‚£ä¸ªåå­—ï¼‰ã€‚å¦‚æœéœ€è¦åŒæ­¥ï¼Œå¯ä»¥åœ¨èœå“ä¿®æ”¹æ—¶æ¸…ç©ºç›¸å…³è´­ç‰©è½¦ã€‚

---

## âœï¸ ç»ƒä¹ ä»»åŠ¡

1. **ç”»å›¾ç»ƒä¹ **ï¼šè‡ªå·±æ‰‹ç”»ä¸€é"æ·»åŠ è´­ç‰©è½¦"çš„æµç¨‹å›¾ï¼ˆä¸çœ‹æˆ‘çš„ï¼‰
2. **ä»£ç é˜…è¯»**ï¼šæ‰¾åˆ° `BaseContext` ç±»ï¼Œç†è§£ ThreadLocal å¦‚ä½•å­˜å–ç”¨æˆ·ID
3. **æ€è€ƒé¢˜**ï¼šå¦‚æœåŒæ—¶æœ‰100ä¸ªç”¨æˆ·åœ¨åŠ è´­ç‰©è½¦ï¼Œä¼šæœ‰å¹¶å‘é—®é¢˜å—ï¼Ÿ

æƒ³ç»§ç»­æ·±å…¥å“ªä¸ªéƒ¨åˆ†ï¼Ÿæ¯”å¦‚ï¼š
- ThreadLocal + BaseContext å®ç°åŸç†
- ä¸‹å•æµç¨‹ï¼ˆè´­ç‰©è½¦ â†’ è®¢å•ï¼‰
- åŠ¨æ€SQLçš„å†™æ³•> 

