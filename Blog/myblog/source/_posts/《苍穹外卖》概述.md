# ğŸ“š è‹ç©¹å¤–å–é¡¹ç›® - é¢è¯•å¿…å­¦çŸ¥è¯†ç‚¹æ¸…å•

ä½œä¸ºé¢è¯•å®˜ï¼Œæˆ‘æŠŠè¿™ä¸ªé¡¹ç›®çš„çŸ¥è¯†ç‚¹åˆ†ä¸º**ä¸‰ä¸ªå±‚æ¬¡**ï¼Œä½ æŒ‰é¡ºåºå­¦ä¹ ï¼š

```mermaid
graph TB
    subgraph ç¬¬ä¸€å±‚[ğŸ¯ ç¬¬ä¸€å±‚ï¼šå¿…é¡»æŒæ¡ - é¢è¯•å¿…é—®]
        A1[Spring Boot æ ¸å¿ƒæ³¨è§£]
        A2[ä¸‰å±‚æ¶æ„ Controller-Service-Mapper]
        A3[JWT ç™»å½•è®¤è¯]
        A4[ThreadLocal ç”¨æˆ·ä¸Šä¸‹æ–‡]
        A5[ç»Ÿä¸€å“åº”å°è£… Result]
        A6[å…¨å±€å¼‚å¸¸å¤„ç†]
    end
    
    subgraph ç¬¬äºŒå±‚[â­ ç¬¬äºŒå±‚ï¼šåŠ åˆ†é¡¹ - ä½“ç°æ·±åº¦]
        B1[AOP åˆ‡é¢ç¼–ç¨‹]
        B2[Spring Cache + Redis ç¼“å­˜]
        B3[MyBatis åŠ¨æ€SQL]
        B4[äº‹åŠ¡ç®¡ç† @Transactional]
    end
    
    subgraph ç¬¬ä¸‰å±‚[ğŸš€ ç¬¬ä¸‰å±‚ï¼šäº®ç‚¹é¡¹ - è„±é¢–è€Œå‡º]
        C1[WebSocket å®æ—¶é€šä¿¡]
        C2[å®šæ—¶ä»»åŠ¡ @Scheduled]
        C3[åˆ†é¡µæŸ¥è¯¢ PageHelper]
        C4[DTO/VO/Entity è®¾è®¡æ¨¡å¼]
    end
    
    A1 --> A2 --> A3 --> A4 --> A5 --> A6
    A6 --> B1 --> B2 --> B3 --> B4
    B4 --> C1 --> C2 --> C3 --> C4
```

---

## ğŸ¯ ç¬¬ä¸€å±‚ï¼šå¿…é¡»æŒæ¡ï¼ˆé¢è¯•å¿…é—®ï¼‰

### 1ï¸âƒ£ Spring Boot æ ¸å¿ƒæ³¨è§£

ä»è¿™ä¸ªé¡¹ç›®ä½ å¿…é¡»å­¦ä¼šçš„æ³¨è§£ï¼š

| æ³¨è§£                         | ä½ç½®         | ä½œç”¨                                | é¢è¯•æ€ä¹ˆé—®              |
| -------------------------- | ---------- | --------------------------------- | ------------------ |
| `@SpringBootApplication`   | å¯åŠ¨ç±»        | ç»„åˆæ³¨è§£ï¼ŒåŒ…å«è‡ªåŠ¨é…ç½®                       | "è¿™ä¸ªæ³¨è§£åŒ…å«å“ªå‡ ä¸ªæ³¨è§£ï¼Ÿ"     |
| `@RestController`          | Controller | = `@Controller` + `@ResponseBody` | "å’Œ@Controllerçš„åŒºåˆ«ï¼Ÿ" |
| `@RequestMapping`          | Controller | å®šä¹‰è¯·æ±‚è·¯å¾„                            | "GETå’ŒPOSTæ€ä¹ˆåŒºåˆ†ï¼Ÿ"    |
| `@Autowired`               | å±æ€§æ³¨å…¥       | ä¾èµ–æ³¨å…¥                              | "å’Œ@Resourceçš„åŒºåˆ«ï¼Ÿ"   |
| `@Service` / `@Component`  | ä¸šåŠ¡ç±»        | æ³¨å†Œä¸ºSpring Bean                    | "è¿™å‡ ä¸ªæ³¨è§£æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"      |
| `@Configuration` + `@Bean` | é…ç½®ç±»        | å£°æ˜é…ç½®å’ŒBean                         | "ä»€ä¹ˆæ—¶å€™ç”¨@Beanï¼Ÿ"      |

---

### 2ï¸âƒ£ ä¸‰å±‚æ¶æ„

```mermaid
sequenceDiagram
    participant å‰ç«¯
    participant Controller
    participant Service
    participant Mapper
    participant æ•°æ®åº“
    
    å‰ç«¯->>Controller: HTTPè¯·æ±‚ (JSON)
    Controller->>Controller: å‚æ•°æ ¡éªŒã€è½¬æ¢
    Controller->>Service: è°ƒç”¨ä¸šåŠ¡æ–¹æ³•
    Service->>Service: ä¸šåŠ¡é€»è¾‘å¤„ç†
    Service->>Mapper: è°ƒç”¨æ•°æ®è®¿é—®
    Mapper->>æ•°æ®åº“: æ‰§è¡ŒSQL
    æ•°æ®åº“-->>Mapper: è¿”å›æ•°æ®
    Mapper-->>Service: Entityå¯¹è±¡
    Service-->>Controller: å¤„ç†åçš„æ•°æ®
    Controller-->>å‰ç«¯: Result<VO>
```

> **ğŸ“Œ é¢è¯•è¿½é—®ï¼š** "ä¸ºä»€ä¹ˆè¦åˆ†ä¸‰å±‚ï¼Ÿç›´æ¥åœ¨Controlleré‡Œå†™SQLä¸è¡Œå—ï¼Ÿ"
> 
> **ç­”ï¼š** èŒè´£åˆ†ç¦»ã€ä¾¿äºæµ‹è¯•ã€ä¾¿äºç»´æŠ¤ã€‚æ¯”å¦‚æ¢æ•°æ®åº“åªéœ€è¦æ”¹Mapperå±‚ã€‚

---

### 3ï¸âƒ£ JWT ç™»å½•è®¤è¯ï¼ˆé‡ç‚¹ï¼ï¼‰

é¡¹ç›®ä¸­çš„å®ç°åœ¨ JwtTokenAdminInterceptor.java

```mermaid
sequenceDiagram
    participant ç”¨æˆ·
    participant Controller
    participant æ‹¦æˆªå™¨
    participant Service
    
    ç”¨æˆ·->>Controller: 1. ç™»å½•(username, password)
    Controller->>Service: 2. éªŒè¯å¯†ç 
    Service-->>Controller: 3. è¿”å›ç”¨æˆ·ä¿¡æ¯
    Controller->>Controller: 4. ç”ŸæˆJWT Token
    Controller-->>ç”¨æˆ·: 5. è¿”å›Token
    
    Note over ç”¨æˆ·,æ‹¦æˆªå™¨: === åç»­è¯·æ±‚ ===
    
    ç”¨æˆ·->>æ‹¦æˆªå™¨: 6. è¯·æ±‚ + Token
    æ‹¦æˆªå™¨->>æ‹¦æˆªå™¨: 7. è§£æéªŒè¯Token
    æ‹¦æˆªå™¨->>æ‹¦æˆªå™¨: 8. å­˜å…¥ThreadLocal
    æ‹¦æˆªå™¨-->>Controller: 9. æ”¾è¡Œ
```

> **ğŸ“Œ é¢è¯•å¿…é—®ï¼š**
> 1. "JWTç”±å“ªä¸‰éƒ¨åˆ†ç»„æˆï¼Ÿ"ï¼ˆHeader.Payload.Signatureï¼‰
> 2. "Tokenè¿‡æœŸäº†æ€ä¹ˆåŠï¼Ÿ"ï¼ˆåˆ·æ–°Tokenæœºåˆ¶ / åŒTokenæ–¹æ¡ˆï¼‰
> 3. "JWTå’ŒSessionçš„åŒºåˆ«ï¼Ÿ"ï¼ˆæ— çŠ¶æ€ vs æœ‰çŠ¶æ€ï¼‰

---

### 4ï¸âƒ£ ThreadLocalï¼ˆè¶…é«˜é¢‘è€ƒç‚¹ï¼ï¼‰

é¡¹ç›®ä¸­çš„å®ç°åœ¨ BaseContext.java

```java
public class BaseContext {
    public static ThreadLocal<Long> threadLocal = new ThreadLocal<>();
    
    public static void setCurrentId(Long id) {
        threadLocal.set(id);  // æ‹¦æˆªå™¨ä¸­è®¾ç½®
    }
    
    public static Long getCurrentId() {
        return threadLocal.get();  // Serviceä¸­è·å–
    }
}
```

```mermaid
graph LR
    subgraph çº¿ç¨‹1
        A1[æ‹¦æˆªå™¨è®¾ç½®userId=1] --> B1[Serviceè·å–userId=1]
    end
    
    subgraph çº¿ç¨‹2
        A2[æ‹¦æˆªå™¨è®¾ç½®userId=2] --> B2[Serviceè·å–userId=2]
    end
    
    style A1 fill:#90EE90
    style A2 fill:#87CEEB
```

> **ğŸ“Œ é¢è¯•å¿…é—®ï¼š**
> 1. "ThreadLocalçš„åŸç†ï¼Ÿ"ï¼ˆæ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ThreadLocalMapï¼‰
> 2. **"ThreadLocalä¼šå†…å­˜æ³„æ¼å—ï¼Ÿæ€ä¹ˆè§£å†³ï¼Ÿ"**ï¼ˆkeyæ˜¯å¼±å¼•ç”¨ï¼Œvalueæ˜¯å¼ºå¼•ç”¨ï¼Œç”¨å®Œè¦removeï¼‰
> 3. "ä¸ºä»€ä¹ˆä¸ç”¨Sessionå­˜userIdï¼Ÿ"ï¼ˆåˆ†å¸ƒå¼ç¯å¢ƒSessionä¸å…±äº«ï¼‰

> âš ï¸ **æˆ‘æ³¨æ„åˆ°è¿™ä¸ªé¡¹ç›®æœ‰ä¸ªé—®é¢˜ï¼š** `BaseContext` æ²¡æœ‰åœ¨è¯·æ±‚ç»“æŸæ—¶è°ƒç”¨ `removeCurrentId()`ï¼Œè¿™åœ¨é«˜å¹¶å‘ä¸‹å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ï¼è¿™æ˜¯ä¸ªé¢è¯•å¯ä»¥æçš„ä¼˜åŒ–ç‚¹ã€‚

---

### 5ï¸âƒ£ ç»Ÿä¸€å“åº”å°è£…

é¡¹ç›®ä¸­çš„å®ç°åœ¨ Result.java

```java
public class Result<T> {
    private Integer code;  // 1æˆåŠŸï¼Œ0å¤±è´¥
    private String msg;    // é”™è¯¯ä¿¡æ¯
    private T data;        // æ•°æ®ï¼ˆæ³›å‹ï¼‰
}
```

> **ğŸ“Œ é¢è¯•ä¼šé—®ï¼š** "ä¸ºä»€ä¹ˆè¦ç»Ÿä¸€å°è£…å“åº”ï¼Ÿ" â†’ å‰ç«¯å¥½å¤„ç†ã€ä¾¿äºå…¨å±€å¼‚å¸¸å¤„ç†

---

### 6ï¸âƒ£ å…¨å±€å¼‚å¸¸å¤„ç†

é¡¹ç›®ä¸­çš„å®ç°åœ¨ GlobalExceptionHandler.java

```java
@RestControllerAdvice  // å…¨å±€æ§åˆ¶å™¨å¢å¼º
public class GlobalExceptionHandler {
    
    @ExceptionHandler  // æ•è·æŒ‡å®šå¼‚å¸¸
    public Result exceptionHandler(BaseException ex){
        return Result.error(ex.getMessage());
    }
}
```

> **ğŸ“Œ é¢è¯•ä¼šé—®ï¼š** 
> 1. "`@RestControllerAdvice`å’Œ`@ControllerAdvice`çš„åŒºåˆ«ï¼Ÿ"
> 2. "å¦‚æœæœ‰å¤šä¸ªExceptionHandlerï¼Œæ‰§è¡Œé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ"ï¼ˆç²¾ç¡®åŒ¹é…ä¼˜å…ˆï¼‰

---

## â­ ç¬¬äºŒå±‚ï¼šåŠ åˆ†é¡¹

### 7ï¸âƒ£ AOP åˆ‡é¢ç¼–ç¨‹ï¼ˆé¡¹ç›®äº®ç‚¹ï¼ï¼‰

é¡¹ç›®ç”¨AOPå®ç°äº†**å…¬å…±å­—æ®µè‡ªåŠ¨å¡«å……**ï¼ˆcreateTime, updateTime, createUser, updateUserï¼‰

æ–‡ä»¶åœ¨ AutoFillAspect.java

```mermaid
graph LR
    A[è°ƒç”¨Mapper.insert] --> B{AOPæ‹¦æˆª}
    B --> C[é€šè¿‡åå°„è‡ªåŠ¨å¡«å……<br/>createTime/createUserç­‰]
    C --> D[æ‰§è¡ŒåŸæ–¹æ³•]
```

> **ğŸ“Œ é¢è¯•å¿…é—®ï¼š**
> 1. "AOPçš„å‡ ç§é€šçŸ¥ç±»å‹ï¼Ÿ"ï¼ˆ@Before, @After, @Around, @AfterReturning, @AfterThrowingï¼‰
> 2. "AOPçš„å®ç°åŸç†ï¼Ÿ"ï¼ˆJDKåŠ¨æ€ä»£ç† vs CGLIBï¼‰
> 3. "ä»€ä¹ˆæƒ…å†µä¸‹AOPä¼šå¤±æ•ˆï¼Ÿ"ï¼ˆè‡ªè°ƒç”¨ã€privateæ–¹æ³•ã€finalç±»ï¼‰

---

### 8ï¸âƒ£ Redis ç¼“å­˜

é¡¹ç›®ä½¿ç”¨äº† `@EnableCaching` å’Œ Spring Cache

> **ğŸ“Œ é¢è¯•å¿…é—®ï¼š**
> 1. "ç¼“å­˜ç©¿é€ã€ç¼“å­˜å‡»ç©¿ã€ç¼“å­˜é›ªå´©æ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆè§£å†³ï¼Ÿ"
> 2. "Redisçš„æ•°æ®ç»“æ„æœ‰å“ªäº›ï¼Ÿåˆ†åˆ«é€‚åˆä»€ä¹ˆåœºæ™¯ï¼Ÿ"
> 3. "å¦‚ä½•ä¿è¯ç¼“å­˜å’Œæ•°æ®åº“çš„ä¸€è‡´æ€§ï¼Ÿ"

---

### 9ï¸âƒ£ äº‹åŠ¡ç®¡ç†

é¡¹ç›®ä½¿ç”¨äº† `@EnableTransactionManagement` å’Œ `@Transactional`

> **ğŸ“Œ é¢è¯•å¿…é—®ï¼š**
> 1. **"@Transactionalä»€ä¹ˆæƒ…å†µä¸‹ä¼šå¤±æ•ˆï¼Ÿ"**ï¼ˆè‡ªè°ƒç”¨ã€épublicã€å¼‚å¸¸è¢«catchã€æ•°æ®åº“ä¸æ”¯æŒï¼‰
> 2. "äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºæœ‰å“ªäº›ï¼ŸREQUIREDå’ŒREQUIRES_NEWçš„åŒºåˆ«ï¼Ÿ"
> 3. "äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼ŸMySQLé»˜è®¤æ˜¯ä»€ä¹ˆï¼Ÿ"

---

## ğŸš€ ç¬¬ä¸‰å±‚ï¼šäº®ç‚¹é¡¹

### ğŸ”Ÿ å®šæ—¶ä»»åŠ¡

é¡¹ç›®ä¸­çš„ OrderTask.java ç”¨äºå¤„ç†è¶…æ—¶è®¢å•ï¼š

```java
@Scheduled(cron = "0 * * * * ?")  // æ¯åˆ†é’Ÿæ‰§è¡Œ
public void processTimeoutOrder() {
    // å–æ¶ˆ15åˆ†é’Ÿæœªæ”¯ä»˜çš„è®¢å•
}
```

> **ğŸ“Œ é¢è¯•ä¼šé—®ï¼š** "åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å®šæ—¶ä»»åŠ¡é‡å¤æ‰§è¡Œæ€ä¹ˆåŠï¼Ÿ"ï¼ˆåˆ†å¸ƒå¼é” / XXL-Job / Elastic-Jobï¼‰

---

### 1ï¸âƒ£1ï¸âƒ£ WebSocket

é¡¹ç›®ç”¨WebSocketå®ç°æ¥å•æé†’ã€å‚¬å•æé†’

> **ğŸ“Œ é¢è¯•ä¼šé—®ï¼š** "WebSocketå’ŒHTTPçš„åŒºåˆ«ï¼Ÿ" "ä»€ä¹ˆæ—¶å€™ç”¨WebSocketï¼Ÿ"

---

## ğŸ“‹ æ€»ç»“ï¼šé¢è¯•å¿…èƒŒæ¸…å•

| ä¼˜å…ˆçº§ | çŸ¥è¯†ç‚¹ | å¯¹åº”é¡¹ç›®æ–‡ä»¶ | é¢è¯•è€ƒé¢‘ |
|--------|--------|-------------|---------|
| â­â­â­ | ThreadLocal | BaseContext.java | ğŸ”¥ğŸ”¥ğŸ”¥ |
| â­â­â­ | JWTè®¤è¯ | JwtTokenAdminInterceptor.java | ğŸ”¥ğŸ”¥ğŸ”¥ |
| â­â­â­ | AOPåŸç† | AutoFillAspect.java | ğŸ”¥ğŸ”¥ğŸ”¥ |
| â­â­â­ | äº‹åŠ¡å¤±æ•ˆåœºæ™¯ | OrderServiceImpl.java | ğŸ”¥ğŸ”¥ğŸ”¥ |
| â­â­â­ | å…¨å±€å¼‚å¸¸å¤„ç† | GlobalExceptionHandler.java | ğŸ”¥ğŸ”¥ |
| â­â­ | Redisç¼“å­˜ | `RedisConfiguration.java` | ğŸ”¥ğŸ”¥ğŸ”¥ |
| â­â­ | MyBatisåŠ¨æ€SQL | `mapper/*.xml` | ğŸ”¥ğŸ”¥ |
| â­ | å®šæ—¶ä»»åŠ¡ | OrderTask.java | ğŸ”¥ |
| â­ | WebSocket | `WebSocketServer.java` | ğŸ”¥ |

---

## ğŸ¯ å­¦ä¹ å»ºè®®

1. **å…ˆæŠŠç¬¬ä¸€å±‚6ä¸ªçŸ¥è¯†ç‚¹åƒé€**ï¼Œè¿™æ˜¯é¢è¯•çš„åŸºæœ¬ç›˜
2. æ¯ä¸ªçŸ¥è¯†ç‚¹éƒ½**æ‰‹å†™ä¸€éä»£ç **ï¼Œä¸è¦åªçœ‹
3. å‡†å¤‡å¥½**é¢è¯•è¯æœ¯**ï¼šç”¨"è¿™ä¸ªé¡¹ç›®ä¸­æˆ‘ç”¨åˆ°äº†xxxï¼Œå…·ä½“æ˜¯åœ¨xxxåœºæ™¯ä¸‹..."è¿™ç§å¥å¼

---

**ä½ æƒ³ä»å“ªä¸ªçŸ¥è¯†ç‚¹å¼€å§‹æ·±å…¥å­¦ä¹ ï¼Ÿæˆ‘å¯ä»¥å¸¦ä½ é€è¡Œè¯»ä»£ç ï¼Œå¹¶æ¨¡æ‹Ÿé¢è¯•è¿½é—®ï¼** ğŸ’ª