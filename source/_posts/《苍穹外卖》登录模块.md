---
title: ã€Šè‹ç©¹å¤–å–ã€‹ç™»å½•æ¨¡å—
tags: [è‹ç©¹å¤–å–]
date: 
---

## é€šä¿—è§£é‡Šï¼ˆå…ˆä¸è¿›ä»£ç ï¼‰

**ç®¡ç†ç«¯ç™»å½•**ï¼šå‰ç«¯æŠŠç”¨æˆ·å/å¯†ç äº¤ç»™åç«¯ â†’ åç«¯æŸ¥åº“æ¯”å¯¹ â†’ é€šè¿‡åç­¾å‘ JWT â†’ å‰ç«¯ä¿å­˜ JWT â†’ ä»¥åæ¯æ¬¡è¯·æ±‚å¸¦ä¸Š JWT â†’ æ‹¦æˆªå™¨éªŒ JWTï¼Œå–å‡ºç”¨æˆ·IDæ”¾åˆ° `ThreadLocal` ç»™ä¸šåŠ¡å±‚ç”¨ã€‚

**ç”¨æˆ·ç«¯ç™»å½•ï¼ˆå¾®ä¿¡ï¼‰**ï¼šå‰ç«¯ç»™å¾®ä¿¡ `code` â†’ åç«¯ç”¨ `code` æ¢ `openid` â†’ æŸ¥åº“æ˜¯å¦å·²æœ‰ç”¨æˆ· â†’ æ²¡æœ‰å°±æ³¨å†Œ â†’ ç»™ç”¨æˆ·ç­¾å‘ JWT â†’ å‰ç«¯ä¿å­˜ â†’ åç»­è¯·æ±‚å¸¦ JWT èµ°æ‹¦æˆªå™¨ã€‚

---

## ä¸šåŠ¡æµç¨‹å›¾ï¼ˆMermaidï¼‰

```mermaid
flowchart TD
    A[å‰ç«¯ç™»å½•è¯·æ±‚] --> B[Controlleræ¥æ”¶DTO]
    B --> C[Serviceæ ¡éªŒ/ç™»å½•]
    C --> D[Mapperè®¿é—®DB]
    D --> C
    C --> E[ç­¾å‘JWT]
    E --> F[VOè¿”å›token]

    F --> G[åç»­è¯·æ±‚å¸¦token]
    G --> H[InterceptoréªŒJWT]
    H --> I[ThreadLocalä¿å­˜ç”¨æˆ·ID]
    I --> J[ä¸šåŠ¡Serviceè¯»å–å½“å‰ç”¨æˆ·ID]
```

---

## ç™»å½•è®¤è¯æ¨¡å—æ¶‰åŠçš„ç±»ï¼ˆæŒ‰èŒè´£æ¢³ç†ï¼‰

### 1) å…¥å£å±‚ï¼ˆControllerï¼‰
- ç®¡ç†ç«¯ç™»å½•å…¥å£ï¼š  
  EmployeeController.java
- ç”¨æˆ·ç«¯ï¼ˆå¾®ä¿¡ï¼‰ç™»å½•å…¥å£ï¼š  
  UserController.java

### 2) ä¸šåŠ¡å±‚ï¼ˆServiceï¼‰
- ç®¡ç†ç«¯ç™»å½•ä¸šåŠ¡æ¥å£/å®ç°ï¼š  
  EmployeeService.java  
  EmployeeServiceImpl.java
- ç”¨æˆ·ç«¯å¾®ä¿¡ç™»å½•ä¸šåŠ¡æ¥å£/å®ç°ï¼š  
  UserService.java  
  UserServiceImpl.java

### 3) æ•°æ®è®¿é—®å±‚ï¼ˆMapper + XMLï¼‰
- ç®¡ç†ç«¯æŸ¥è¯¢å‘˜å·¥ï¼š  
  EmployeeMapper.java  
  EmployeeMapper.xml
- ç”¨æˆ·ç«¯æŸ¥è¯¢/æ³¨å†Œï¼š  
  UserMapper.java  
  UserMapper.xml

### 4) JWT ä¸ä¸Šä¸‹æ–‡
- JWT ç”Ÿæˆ/è§£æå·¥å…·ï¼š  
  JwtUtil.java
- JWT é…ç½®ï¼š  
  JwtProperties.java
- ç®¡ç†ç«¯ JWT æ‹¦æˆªå™¨ï¼š  
  JwtTokenAdminInterceptor.java
- ç”¨æˆ·ç«¯ JWT æ‹¦æˆªå™¨ï¼š  
  JwtTokenUserInterceptor.java
- çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼ˆThreadLocalï¼‰ï¼š  
  BaseContext.java

### 5) DTO / VO / Entity
- ç®¡ç†ç«¯ç™»å½• DTO/VO/å®ä½“ï¼š  
  EmployeeLoginDTO.java  
  EmployeeLoginVO.java  
  Employee.java
- ç”¨æˆ·ç«¯ç™»å½• DTO/VO/å®ä½“ï¼š  
  UserLoginDTO.java  
  UserLoginVO.java  
  User.java

### 6) æ‹¦æˆªå™¨æ³¨å†Œ
- æ‹¦æˆªå™¨é…ç½®ï¼š  
  WebMvcConfiguration.java

---

## ç±»ä¹‹é—´çš„é€»è¾‘å…³ç³»ï¼ˆæ ¸å¿ƒé“¾è·¯ï¼‰

**ç®¡ç†ç«¯ç™»å½•é“¾è·¯ï¼š**  
`EmployeeController` â†’ `EmployeeServiceImpl` â†’ `EmployeeMapper` â†’ DB â†’ `JwtUtil` â†’ è¿”å› `EmployeeLoginVO`

**ç”¨æˆ·ç«¯ç™»å½•é“¾è·¯ï¼ˆå¾®ä¿¡ï¼‰ï¼š**  
`UserController` â†’ `UserServiceImpl` â†’ `UserMapper` â†’ DB â†’ `JwtUtil` â†’ è¿”å› `UserLoginVO`

**ç™»å½•åè®¿é—®èµ„æºé“¾è·¯ï¼š**  
`JwtToken*Interceptor` â†’ `JwtUtil.parseJWT` â†’ `BaseContext.setCurrentId` â†’ ä¸šåŠ¡ `Service` é€šè¿‡ `BaseContext.getCurrentId`

---

## æˆ‘å¿…é¡»ä¸¥å‰æŒ‡å‡ºçš„é£é™©ç‚¹ï¼ˆæ•°æ®ä¸€è‡´æ€§ï¼‰

**ç”¨æˆ·ç«¯å¾®ä¿¡ç™»å½•å­˜åœ¨å¹¶å‘é£é™©**ï¼š  
åŒæ—¶ä¸¤ä¸ªè¯·æ±‚ç”¨åŒä¸€ä¸ª `openid` ç™»å½•ï¼Œå¯èƒ½å‡ºç°**å¹¶å‘æ’å…¥ä¸¤æ¡ç”¨æˆ·è®°å½•**ã€‚  
**æ­£ç¡®åšæ³•**ï¼šæ•°æ®åº“ `openid` è®¾å”¯ä¸€ç´¢å¼• + ä»£ç å±‚æ•è·é‡å¤æ’å…¥å¼‚å¸¸åšå¹‚ç­‰å¤„ç†ã€‚

---

## é¢è¯•å¯¼å‘ï¼šè¿™äº›ç‚¹é€šå¸¸ä¼šæ€ä¹ˆé—®ï¼Ÿ

### 1) JWT
**é¢è¯•æ€ä¹ˆé—®ï¼š**  
â€œJWT çš„ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆç”¨ JWT è€Œä¸æ˜¯ Sessionï¼Ÿâ€  
**è¿½é—®ï¼š**  
- â€œJWT è¢«ç›—æ€ä¹ˆåŠï¼Ÿâ€  
- â€œæ€ä¹ˆå®ç° Token ç»­ç­¾ï¼Ÿâ€

### 2) ThreadLocal
**é¢è¯•æ€ä¹ˆé—®ï¼š**  
â€œThreadLocal ä¸ºä»€ä¹ˆèƒ½åšåˆ°çº¿ç¨‹éš”ç¦»ï¼Ÿâ€  
**è¿½é—®ï¼š**  
- â€œThreadLocal å†…å­˜æ³„æ¼æ€ä¹ˆäº§ç”Ÿï¼Ÿâ€  
- â€œçº¿ç¨‹æ± é‡Œæ€ä¹ˆé¿å…ï¼Ÿâ€

### 3) MyBatis Mapper
**é¢è¯•æ€ä¹ˆé—®ï¼š**  
â€œMapper æ¥å£æ²¡æœ‰å®ç°ç±»ï¼Œä¸ºä»€ä¹ˆèƒ½æ‰§è¡Œï¼Ÿâ€  
**è¿½é—®ï¼š**  
- â€œ#{} å’Œ ${} æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿâ€  

### 4) DTO/VO
**é¢è¯•æ€ä¹ˆé—®ï¼š**  
â€œDTO å’Œ VO çš„åŒºåˆ«ï¼Ÿä¸ºä»€ä¹ˆä¸ç”¨ Entity ç›´æ¥æ¥æ”¶å‚æ•°ï¼Ÿâ€  
**è¿½é—®ï¼š**  
- â€œå¦‚æœç›´æ¥ç”¨ Entity ä¼šæœ‰ä»€ä¹ˆå®‰å…¨é—®é¢˜ï¼Ÿâ€

---

## é«˜å¹¶å‘åœºæ™¯ä¸‹å¸¸è§ä¼˜åŒ–ï¼ˆé¡ºå¸¦æ‰©å±•ï¼‰

- JWT é»‘åå• + Redisï¼šæ”¯æŒå¼ºåˆ¶ä¸‹çº¿  
- å¤±è´¥æ¬¡æ•°é™æµï¼šé˜²æš´åŠ›ç ´è§£  
- å¯†ç å­˜å‚¨æ”¹ BCryptï¼ˆåŠ ç›ï¼‰  
- å¾®ä¿¡ç™»å½•åŠ å”¯ä¸€ç´¢å¼• + å¹‚ç­‰å¤„ç†

---

å¦‚æœä½ æƒ³ï¼Œæˆ‘å¯ä»¥æŠŠ**æ¯ä¸ªç±»çš„å…³é”®æ–¹æ³•**é€ä¸ªå¸¦ä½ è¿‡ä¸€éï¼ˆä»ç„¶æŒ‰â€œå…ˆæµç¨‹å›¾å†ä»£ç â€ï¼‰ã€‚  
ä½ æƒ³å…ˆçœ‹**ç®¡ç†ç«¯ç™»å½•**è¿˜æ˜¯**ç”¨æˆ·ç«¯å¾®ä¿¡ç™»å½•**ï¼Ÿ


## âŒ ä½ ç†è§£é”™è¯¯çš„åœ°æ–¹

ä½ è¯´ï¼š
> "controllerå±‚è¿”å›å®ä½“ â†’ **è¿›å…¥jwtæ‹¦æˆªå™¨æ¨¡å—** â†’ ç™»å½•æˆåŠŸ"

**è¿™æ˜¯å®Œå…¨é”™è¯¯çš„ï¼** JWTæ‹¦æˆªå™¨**ä¸æ˜¯åœ¨ç™»å½•æ—¶æ‰§è¡Œçš„**ï¼Œè€Œæ˜¯åœ¨**ç™»å½•ä¹‹åçš„å…¶ä»–è¯·æ±‚**æ—¶æ‰§è¡Œï¼

è®©æˆ‘ç”»ä¸¤å¼ å›¾å¯¹æ¯”ï¼š

### âœ… æ­£ç¡®çš„æµç¨‹åº”è¯¥æ˜¯è¿™æ ·ï¼š

```mermaid
sequenceDiagram
    participant å‰ç«¯
    participant Controller
    participant Service
    participant Mapper
    participant DB
    participant JWTå·¥å…·
    
    rect rgb(255, 200, 200)
        Note over å‰ç«¯,JWTå·¥å…·: ã€åœºæ™¯ä¸€ï¼šç™»å½•è¯·æ±‚ - ä¸ç»è¿‡æ‹¦æˆªå™¨ï¼ã€‘
        å‰ç«¯->>Controller: POST /admin/employee/login<br/>{username, password}
        Note over Controller: âš ï¸ ç™»å½•æ¥å£åœ¨WebMvcConfigurationä¸­<br/>è¢«excludePathPatternsæ’é™¤äº†<br/>æ‰€ä»¥ä¸ä¼šè¢«æ‹¦æˆªå™¨æ‹¦æˆªï¼
        Controller->>Service: login(employeeLoginDTO)
        Service->>Mapper: getByUsername(username)
        Mapper->>DB: SELECT * FROM employee WHERE username=?
        DB-->>Mapper: è¿”å›æŸ¥è¯¢ç»“æœ
        Mapper-->>Service: Employeeå¯¹è±¡
        Service->>Service: ä¸‰é“æ ¡éªŒï¼ˆå­˜åœ¨ï¼Ÿå¯†ç ï¼Ÿé”å®šï¼Ÿï¼‰
        Service-->>Controller: è¿”å›Employee
        Controller->>JWTå·¥å…·: ç”ŸæˆToken
        JWTå·¥å…·-->>Controller: è¿”å›tokenå­—ç¬¦ä¸²
        Controller-->>å‰ç«¯: {id, name, token} âœ… ç™»å½•æˆåŠŸ
    end
    
    rect rgb(200, 255, 200)
        Note over å‰ç«¯,JWTå·¥å…·: ã€åœºæ™¯äºŒï¼šè®¿é—®å…¶ä»–æ¥å£ - æ‹¦æˆªå™¨å·¥ä½œï¼ã€‘
        å‰ç«¯->>Controller: GET /admin/dish/page<br/>Header: token=xxx
        Note over Controller: ğŸ‘® æ‹¦æˆªå™¨æ‹¦æˆªï¼
        Controller->>Controller: JwtTokenAdminInterceptor.preHandle()
        Controller->>JWTå·¥å…·: è§£ætoken
        JWTå·¥å…·-->>Controller: è¿”å›empId
        Controller->>Controller: BaseContext.setCurrentId(empId)
        Note over Controller: âœ… æ”¾è¡Œ
        Controller->>Service: å¤„ç†ä¸šåŠ¡
        Service-->>Controller: è¿”å›æ•°æ®
        Controller-->>å‰ç«¯: å“åº”ç»“æœ
    end
```

çœ‹åˆ°åŒºåˆ«äº†å—ï¼Ÿ**ç™»å½•å’Œè®¿é—®èµ„æºæ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„è¿‡ç¨‹ï¼**

---

## ç°åœ¨è®©æˆ‘é€ä¸ªè§£ç­”ä½ çš„ç–‘æƒ‘

### 1ï¸âƒ£ DTOæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦ç”¨å®ƒï¼Ÿ

ä½ é—®ï¼š
> "EmployeeLoginDTOæ˜¯å¹²ä»€ä¹ˆç”¨çš„ï¼Ÿ"


å¥½ï¼ç°åœ¨æˆ‘ç”¨**æœ€é€šä¿—çš„æ¯”å–»**ç»™ä½ è®²æ¸…æ¥šDTO/Entity/VOçš„åŒºåˆ«ï¼š

```
æƒ³è±¡ä½ å»é“¶è¡ŒåŠä¸šåŠ¡ï¼š

ğŸ“‹ DTO (Data Transfer Object) - åŠä¸šåŠ¡æ—¶å¡«çš„è¡¨æ ¼
   EmployeeLoginDTO { username, password }
   â†’ åªåŒ…å«"ç™»å½•éœ€è¦çš„ä¿¡æ¯"ï¼Œä¸éœ€è¦phoneã€sexè¿™äº›æ— å…³å­—æ®µ
   â†’ ä»å‰ç«¯ä¼ åˆ°åç«¯

ğŸ¦ Entity - é“¶è¡Œå†…éƒ¨çš„å®Œæ•´æ¡£æ¡ˆ
   Employee { id, username, name, password, phone, sex, ... }
   â†’ åŒ…å«æ•°æ®åº“æ‰€æœ‰å­—æ®µ
   â†’ å¯¹åº”æ•°æ®åº“è¡¨ç»“æ„

ğŸ“„ VO (View Object) - ç»™ä½ çš„å›æ‰§å•
   EmployeeLoginVO { id, userName, name, token }
   â†’ åªåŒ…å«"å‰ç«¯éœ€è¦æ˜¾ç¤ºçš„ä¿¡æ¯"ï¼Œä¸èƒ½æŠŠpasswordè¿”å›ç»™å‰ç«¯ï¼
   â†’ ä»åç«¯ä¼ åˆ°å‰ç«¯
```

**ä¸ºä»€ä¹ˆè¦åˆ†å¼€ï¼Ÿç›´æ¥ç”¨Entityä¸è¡Œå—ï¼Ÿ**

âŒ **å¦‚æœç›´æ¥ç”¨Entityä¼šæœ‰å¤§é—®é¢˜ï¼š**
```java
// å‡è®¾ä¸ç”¨DTOï¼Œç›´æ¥æ¥æ”¶Employee
@PostMapping("/login")
public Result login(@RequestBody Employee employee) {
    // é—®é¢˜1ï¼šå‰ç«¯å¯ä»¥ä¼ å…¥ä»»æ„å­—æ®µï¼
    // å‰ç«¯å¯èƒ½æ¶æ„ä¼ ï¼š{"username":"admin", "status":1, "id":999}
    // ç›´æ¥æŠŠè‡ªå·±è®¾ç½®æˆç®¡ç†å‘˜ï¼
    
    // é—®é¢˜2ï¼šè¿”å›Employeeä¼šæ³„éœ²å¯†ç ï¼
    return Result.success(employee);  // passwordä¼šè¢«ä¼ åˆ°å‰ç«¯ï¼
}
```

**âœ… ä½¿ç”¨DTO/VOçš„å¥½å¤„ï¼š**
```java
// DTOï¼šåªæ¥æ”¶éœ€è¦çš„å­—æ®µï¼Œé˜²æ­¢å‚æ•°æ±¡æŸ“
EmployeeLoginDTO { username, password }  

// VOï¼šåªè¿”å›å®‰å…¨çš„å­—æ®µï¼Œé˜²æ­¢ä¿¡æ¯æ³„éœ²
EmployeeLoginVO { id, userName, name, token }  // æ²¡æœ‰passwordï¼
```

---

### 2ï¸âƒ£ Mapperå±‚æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ

> "mapperå±‚çš„ç»†èŠ‚æˆ‘ä¸ç†è§£"

### Mapperå±‚å·¥ä½œåŸç†ï¼ˆMyBatisæ¡†æ¶ï¼‰

```mermaid
graph LR
    A[Serviceè°ƒç”¨] -->|employeeMapper.getByUsername| B[Mapperæ¥å£]
    B --> C[MyBatisä»£ç†å¯¹è±¡]
    C --> D[EmployeeMapper.xml]
    D --> E[æ‰§è¡ŒSQL]
    E --> F[è¿”å›Employeeå¯¹è±¡]
    
    style C fill:#ffcccc
    style D fill:#ccffcc
```

#### ç¬¬ä¸€æ­¥ï¼šå®šä¹‰æ¥å£ï¼ˆä¸éœ€è¦å®ç°ç±»ï¼ï¼‰

```java
// ğŸ“ EmployeeMapper.java (æ¥å£)
@Mapper  // ğŸ‘ˆ è¿™ä¸ªæ³¨è§£å‘Šè¯‰Springï¼šæˆ‘æ˜¯MyBatisçš„Mapper
public interface EmployeeMapper {
    
    // ğŸ‘€ æ³¨æ„ï¼šè¿™é‡Œåªæœ‰æ–¹æ³•å£°æ˜ï¼Œæ²¡æœ‰å®ç°ï¼
    Employee getByUsername(@Param("username") String username);
    
    // @Param("username") çš„æ„æ€æ˜¯ï¼š
    // åœ¨XMLé‡Œå¯ä»¥ç”¨ #{username} æ¥å¼•ç”¨è¿™ä¸ªå‚æ•°
}
```

#### ç¬¬äºŒæ­¥ï¼šXMLä¸­å†™SQL

```xml
<!-- ğŸ“ EmployeeMapper.xml -->
<mapper namespace="com.sky.mapper.EmployeeMapper">
    <!-- 
        id="getByUsername" å¯¹åº”æ¥å£ä¸­çš„æ–¹æ³•å
        resultType æŒ‡å®šè¿”å›ç±»å‹
    -->
    <select id="getByUsername" resultType="com.sky.entity.Employee">
        select * from employee where username = #{username}
        <!-- #{username} ä¼šè¢«æ›¿æ¢æˆå‚æ•°å€¼ï¼Œå¹¶ä¸”é˜²æ­¢SQLæ³¨å…¥ -->
    </select>
</mapper>
```

#### ç¬¬ä¸‰æ­¥ï¼šMyBatisè‡ªåŠ¨ç”Ÿæˆå®ç°ç±»ï¼ˆåŠ¨æ€ä»£ç†ï¼‰

```java
// å½“ä½ è°ƒç”¨ï¼š
Employee emp = employeeMapper.getByUsername("admin");

// MyBatisåœ¨èƒŒååšäº†ä»€ä¹ˆï¼Ÿ
/*
1. æ£€æµ‹åˆ° getByUsername æ–¹æ³•è¢«è°ƒç”¨
2. å»XMLä¸­æ‰¾ id="getByUsername" çš„SQL
3. æŠŠå‚æ•° "admin" æ›¿æ¢åˆ° #{username} ä½ç½®
4. æ‰§è¡ŒSQLï¼š SELECT * FROM employee WHERE username = 'admin'
5. æŠŠæŸ¥è¯¢ç»“æœå°è£…æˆ Employee å¯¹è±¡
6. è¿”å›
*/
```

**ğŸ¯ é¢è¯•ä¼šé—®ï¼šMyBatisçš„åº•å±‚åŸç†ï¼Ÿ**

å›ç­”è¦ç‚¹ï¼š
```
1. åŠ¨æ€ä»£ç†ï¼šMyBatisä¸ºMapperæ¥å£ç”Ÿæˆä»£ç†å¯¹è±¡ï¼ˆJDKåŠ¨æ€ä»£ç†ï¼‰
2. SqlSessionï¼šæ¯æ¬¡æ•°æ®åº“æ“ä½œéƒ½é€šè¿‡SqlSessionæ‰§è¡Œ
3. å‚æ•°æ˜ å°„ï¼š#{} é¢„ç¼–è¯‘é˜²SQLæ³¨å…¥ï¼Œ${} ç›´æ¥æ‹¼æ¥ï¼ˆæœ‰æ³¨å…¥é£é™©ï¼‰
4. ç»“æœæ˜ å°„ï¼šè‡ªåŠ¨æŠŠResultSetå°è£…æˆJavaå¯¹è±¡
```

---

### 3ï¸âƒ£ JWTç”Ÿæˆçš„ä»£ç è¯¦è§£

ä½ è¯´ï¼š
> "ç”Ÿæˆjwtä»¤ç‰Œè¿™æ®µä»£ç æˆ‘ä¸ç†è§£"

è®©æˆ‘**é€è¡Œæ‹†è§£**ç»™ä½ çœ‹ï¼š

```java
// ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡è½½è·æ•°æ®ï¼ˆPayloadï¼‰
Map<String, Object> claims = new HashMap<>();
claims.put(JwtClaimsConstant.EMP_ID, employee.getId());  
// ğŸ‘† æŠŠå‘˜å·¥IDæ”¾è¿›å»ï¼Œåé¢æ‹¦æˆªå™¨ä¼šç”¨åˆ°

// ç¬¬äºŒæ­¥ï¼šè°ƒç”¨å·¥å…·ç±»ç”ŸæˆToken
String token = JwtUtil.createJWT(
    jwtProperties.getAdminSecretKey(),  // å¯†é’¥ï¼š"sky123456"ï¼ˆä»é…ç½®æ–‡ä»¶è¯»ï¼‰
    jwtProperties.getAdminTtl(),         // è¿‡æœŸæ—¶é—´ï¼š7200000æ¯«ç§’ = 2å°æ—¶
    claims                                // è½½è·æ•°æ®ï¼š{empId: 1}
);
```

ç°åœ¨è¿›å…¥**JwtUtil.createJWTæ–¹æ³•å†…éƒ¨**ï¼š

```java
public static String createJWT(String secretKey, long ttlMillis, Map<String, Object> claims) {
    
    // ğŸ” 1. æŒ‡å®šåŠ å¯†ç®—æ³•
    SignatureAlgorithm signatureAlgorithm = SignatureAlgorithm.HS256;
    // HS256 = HMAC-SHA256ï¼Œæ˜¯ä¸€ç§å¯¹ç§°åŠ å¯†ç®—æ³•
    
    // â° 2. è®¡ç®—è¿‡æœŸæ—¶é—´
    long expMillis = System.currentTimeMillis() + ttlMillis;
    // å½“å‰æ—¶é—´ + 2å°æ—¶ = è¿‡æœŸæ—¶é—´æˆ³
    Date exp = new Date(expMillis);
    
    // ğŸ”¨ 3. æ„å»ºJWT
    JwtBuilder builder = Jwts.builder()
        .setClaims(claims)           // è®¾ç½®è½½è·ï¼š{empId: 1}
        .signWith(                    // è®¾ç½®ç­¾å
            signatureAlgorithm,       // ç®—æ³•ï¼šHS256
            secretKey.getBytes(UTF_8) // å¯†é’¥ï¼šè½¬æˆå­—èŠ‚æ•°ç»„
        )
        .setExpiration(exp);          // è®¾ç½®è¿‡æœŸæ—¶é—´
    
    // ğŸ“¦ 4. ç”Ÿæˆæœ€ç»ˆçš„tokenå­—ç¬¦ä¸²
    return builder.compact();
    // è¿”å›ç±»ä¼¼ï¼šeyJhbGciOiJIUzI1NiJ9.eyJlbXBJZCI6MX0.xxxxx
}
```

**ç”Ÿæˆçš„Tokené•¿ä»€ä¹ˆæ ·ï¼Ÿ**

```
eyJhbGciOiJIUzI1NiJ9.eyJlbXBJZCI6MX0.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
     â†‘                    â†‘                          â†‘
   Header              Payload                   Signature
   å¤´éƒ¨                 è½½è·                       ç­¾å
```

ç”¨åœ¨çº¿å·¥å…·è§£ç åçœ‹åˆ°ï¼š
```json
// Header
{
  "alg": "HS256",  // ç®—æ³•
  "typ": "JWT"     // ç±»å‹
}

// Payload
{
  "empId": 1,           // æˆ‘ä»¬æ”¾è¿›å»çš„æ•°æ®
  "exp": 1706832000     // è¿‡æœŸæ—¶é—´æˆ³
}

// Signatureï¼ˆç”¨å¯†é’¥åŠ å¯†çš„ï¼Œæ— æ³•è§£ç ï¼‰
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  "sky123456"  // å¯†é’¥
)
```

---

### 4ï¸âƒ£ JWTæ‹¦æˆªå™¨çš„å®Œæ•´é€»è¾‘

ç°åœ¨æ˜¯**é‡ç‚¹ä¸­çš„é‡ç‚¹**ï¼è®©æˆ‘è¯¦ç»†æ‹†è§£æ‹¦æˆªå™¨çš„æ¯ä¸€æ­¥ï¼š

#### åœºæ™¯è¿˜åŸï¼š

```
å‡è®¾ä½ å·²ç»ç™»å½•æˆåŠŸï¼Œè·å¾—äº†tokenï¼š
eyJhbGciOiJIUzI1NiJ9.eyJlbXBJZCI6MX0.xxxxx

ç°åœ¨ä½ è¦æŸ¥è¯¢èœå“åˆ—è¡¨ï¼Œå‘é€è¯·æ±‚ï¼š
GET /admin/dish/page
Header: token=eyJhbGciOiJIUzI1NiJ9.eyJlbXBJZCI6MX0.xxxxx
```

#### æ‹¦æˆªå™¨ä»£ç é€è¡Œè§£æï¼š

```java
@Component
public class JwtTokenAdminInterceptor implements HandlerInterceptor {

    @Autowired
    private JwtProperties jwtProperties;

    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, 
                            Object handler) throws Exception {
        
        // ğŸš¦ ç¬¬ä¸€æ­¥ï¼šåˆ¤æ–­æ˜¯ä¸æ˜¯Controlleræ–¹æ³•
        if (!(handler instanceof HandlerMethod)) {
            return true;  // å¦‚æœæ˜¯é™æ€èµ„æºï¼ˆå›¾ç‰‡ã€CSSç­‰ï¼‰ï¼Œç›´æ¥æ”¾è¡Œ
        }
        
        // ğŸ“¨ ç¬¬äºŒæ­¥ï¼šä»è¯·æ±‚å¤´è·å–token
        String token = request.getHeader(jwtProperties.getAdminTokenName());
        // jwtProperties.getAdminTokenName() è¿”å› "token"
        // æ‰€ä»¥è¿™è¡Œä»£ç ç›¸å½“äºï¼šrequest.getHeader("token")
        
        try {
            // ğŸ”“ ç¬¬ä¸‰æ­¥ï¼šè§£æJWT
            Claims claims = JwtUtil.parseJWT(jwtProperties.getAdminSecretKey(), token);
            // parseJWTå†…éƒ¨åšäº†ä»€ä¹ˆï¼Ÿ
            /*
            1. ç”¨å¯†é’¥éªŒè¯ç­¾åï¼ˆé˜²æ­¢tokenè¢«ç¯¡æ”¹ï¼‰
            2. æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            3. è§£æå‡ºPayloadéƒ¨åˆ†
            4. è¿”å›Claimså¯¹è±¡ï¼ˆå°±æ˜¯ä¸€ä¸ªMapï¼‰
            */
            
            // ğŸ“Œ ç¬¬å››æ­¥ï¼šæå–ç”¨æˆ·ID
            Long empId = Long.valueOf(claims.get(JwtClaimsConstant.EMP_ID).toString());
            // claims.get("empId") æ‹¿åˆ° 1
            
            // â­ ç¬¬äº”æ­¥ï¼šå­˜å…¥ThreadLocalï¼ˆå…³é”®ï¼ï¼‰
            BaseContext.setCurrentId(empId);
            // ğŸ‘† è¿™ä¸€æ­¥éå¸¸é‡è¦ï¼åé¢Serviceå±‚ä¼šç”¨åˆ°
            
            // âœ… ç¬¬å…­æ­¥ï¼šæ”¾è¡Œ
            return true;
            
        } catch (Exception ex) {
            // âŒ å¦‚æœtokenæ— æ•ˆã€è¿‡æœŸã€è¢«ç¯¡æ”¹ï¼Œéƒ½ä¼šæŠ›å¼‚å¸¸
            response.setStatus(401);  // è¿”å›401æœªæˆæƒ
            return false;              // æ‹¦æˆªè¯·æ±‚
        }
    }
}
```

#### ThreadLocalçš„ä½œç”¨ï¼ˆå¿…é—®è€ƒç‚¹ï¼ï¼‰

```java
// ğŸ“ BaseContext.java
public class BaseContext {
    public static ThreadLocal<Long> threadLocal = new ThreadLocal<>();
    
    public static void setCurrentId(Long id) {
        threadLocal.set(id);  // æ‹¦æˆªå™¨è°ƒç”¨ï¼šå­˜å…¥empId
    }
    
    public static Long getCurrentId() {
        return threadLocal.get();  // Serviceå±‚è°ƒç”¨ï¼šå–å‡ºempId
    }
}
```

**ä¸ºä»€ä¹ˆè¦ç”¨ThreadLocalï¼Ÿ**

å‡è®¾**åŒæ—¶æœ‰ä¸¤ä¸ªç”¨æˆ·è®¿é—®**ï¼š

```
ğŸ‘¤ ç”¨æˆ·A(empId=1) è®¿é—® /admin/dish/page
ğŸ‘¤ ç”¨æˆ·B(empId=2) è®¿é—® /admin/employee/page

å¦‚æœç”¨æ™®é€šå˜é‡ï¼š
public class BaseContext {
    public static Long currentId;  // âŒ é—®é¢˜ï¼šåªæœ‰ä¸€ä¸ªå˜é‡ï¼
}

çº¿ç¨‹A: currentId = 1  â† å­˜å…¥
çº¿ç¨‹B: currentId = 2  â† è¦†ç›–äº†ï¼
çº¿ç¨‹A: è·å–currentId  â† æ‹¿åˆ°2ï¼Œé”™äº†ï¼ç”¨æˆ·Aæ‹¿åˆ°äº†ç”¨æˆ·Bçš„IDï¼
```

**ç”¨ThreadLocalåï¼š**
```
ThreadLocalç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…ç‹¬ç«‹ç©ºé—´ï¼š

çº¿ç¨‹Açš„ç©ºé—´ï¼šcurrentId = 1
çº¿ç¨‹Bçš„ç©ºé—´ï¼šcurrentId = 2

äº’ä¸å¹²æ‰°ï¼âœ…
```

---

### 5ï¸âƒ£ JWTã€Sessionã€ThreadLocalé¢è¯•é¢˜è¯¦è§£

#### **JWTåŸç†**

```
JWT = JSON Web Token

ç»„æˆéƒ¨åˆ†ï¼ˆç”¨.åˆ†éš”ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header.Payload.Signature               â”‚
â”‚ å¤´éƒ¨    è½½è·     ç­¾å                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Headerï¼ˆå¤´éƒ¨ï¼‰
   {
     "alg": "HS256",  // åŠ å¯†ç®—æ³•
     "typ": "JWT"      // ç±»å‹
   }
   â†’ Base64ç¼–ç 

2. Payloadï¼ˆè½½è·ï¼‰
   {
     "empId": 1,       // æˆ‘ä»¬çš„æ•°æ®
     "exp": 1706832000 // è¿‡æœŸæ—¶é—´
   }
   â†’ Base64ç¼–ç 
   âš ï¸ æ³¨æ„ï¼šåªæ˜¯ç¼–ç ï¼Œä¸æ˜¯åŠ å¯†ï¼ä»»ä½•äººéƒ½èƒ½è§£ç çœ‹åˆ°ï¼
   æ‰€ä»¥ä¸è¦æ”¾å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯ï¼

3. Signatureï¼ˆç­¾åï¼‰
   HMACSHA256(
     base64(header) + "." + base64(payload),
     secretKey  // å¯†é’¥åªæœ‰æœåŠ¡å™¨çŸ¥é“
   )
   â†’ é˜²æ­¢tokenè¢«ç¯¡æ”¹
```

**JWTçš„æ ¸å¿ƒä¼˜åŠ¿ï¼š**
```
1. æ— çŠ¶æ€ï¼šæœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨Session
2. åˆ†å¸ƒå¼å‹å¥½ï¼šå¤šå°æœåŠ¡å™¨å…±ç”¨å¯†é’¥å³å¯éªŒè¯
3. è·¨åŸŸå‹å¥½ï¼šæ”¾åœ¨Headeré‡Œï¼Œä¸ä¾èµ–Cookie
```

---

#### **Session vs JWTå¯¹æ¯”**

| å¯¹æ¯”é¡¹ | Session | JWT |
|--------|---------|-----|
| **å­˜å‚¨ä½ç½®** | æœåŠ¡å™¨å†…å­˜/Redis | å®¢æˆ·ç«¯ï¼ˆlocalStorage/Headerï¼‰ |
| **æœåŠ¡å™¨å‹åŠ›** | å¤§ï¼ˆéœ€è¦å­˜å‚¨ï¼‰ | å°ï¼ˆæ— çŠ¶æ€ï¼‰ |
| **åˆ†å¸ƒå¼éƒ¨ç½²** | éœ€è¦Sessionå…±äº« | å¤©ç„¶æ”¯æŒ |
| **æ³¨é”€** | ç›´æ¥åˆ é™¤Session | éœ€è¦é»‘åå•æœºåˆ¶ |
| **å®‰å…¨æ€§** | ç›¸å¯¹å®‰å…¨ | Tokenæ³„éœ²é£é™© |

**ä»€ä¹ˆæ—¶å€™ç”¨Sessionï¼Ÿä»€ä¹ˆæ—¶å€™ç”¨JWTï¼Ÿ**
```
Sessionï¼šä¼ä¸šå†…éƒ¨ç³»ç»Ÿã€å®‰å…¨æ€§è¦æ±‚é«˜
JWTï¼šç§»åŠ¨APPã€å¾®æœåŠ¡ã€åˆ†å¸ƒå¼ç³»ç»Ÿ
```

---

#### **ThreadLocalæ·±åº¦è§£æ**

**åº•å±‚åŸç†ï¼š**
```java
// æ¯ä¸ªThreadå¯¹è±¡å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªMap
class Thread {
    ThreadLocal.ThreadLocalMap threadLocals;  // ğŸ‘ˆ å…³é”®ï¼
}

// ThreadLocalçš„get/setæ“ä½œçš„æ˜¯å½“å‰çº¿ç¨‹çš„Map
public void set(T value) {
    Thread t = Thread.currentThread();  // è·å–å½“å‰çº¿ç¨‹
    ThreadLocalMap map = t.threadLocals; // è·å–è¿™ä¸ªçº¿ç¨‹çš„Map
    map.put(this, value);                 // ä»¥ThreadLocalå¯¹è±¡ä¸ºkeyå­˜å€¼
}

public T get() {
    Thread t = Thread.currentThread();
    ThreadLocalMap map = t.threadLocals;
    return map.get(this);
}
```

**é€šä¿—ç†è§£ï¼š**
```
ThreadLocalå°±åƒå­¦æ ¡çš„å‚¨ç‰©æŸœï¼š

ğŸ« æ•™å­¦æ¥¼ = JVM
ğŸ“¦ å‚¨ç‰©æŸœç³»ç»Ÿ = ThreadLocal
ğŸ‘¨â€ğŸ“ å­¦ç”ŸA(çº¿ç¨‹A) = 1å·æŸœå­ â†’ å­˜çš„æ˜¯empId=1
ğŸ‘©â€ğŸ“ å­¦ç”ŸB(çº¿ç¨‹B) = 2å·æŸœå­ â†’ å­˜çš„æ˜¯empId=2

æ¯ä¸ªå­¦ç”Ÿåªèƒ½æ‰“å¼€è‡ªå·±çš„æŸœå­ï¼Œäº’ä¸å¹²æ‰°ï¼
```

**âš ï¸ å†…å­˜æ³„æ¼é—®é¢˜ï¼ˆå¿…é—®ï¼ï¼‰**

```java
// é—®é¢˜åœºæ™¯ï¼š
åœ¨Tomcatçº¿ç¨‹æ± ä¸­ï¼Œçº¿ç¨‹ä¸ä¼šè¢«é”€æ¯ï¼Œä¼šè¢«å¤ç”¨ï¼

è¯·æ±‚1æ¥äº† â†’ çº¿ç¨‹A â†’ ThreadLocal.set(empId=1)
è¯·æ±‚1ç»“æŸ â†’ çº¿ç¨‹Aè¢«æ”¾å›çº¿ç¨‹æ± ï¼ˆæ²¡æœ‰é”€æ¯ï¼ï¼‰
è¯·æ±‚2æ¥äº† â†’ çº¿ç¨‹Aè¢«å¤ç”¨ â†’ ThreadLocal.get() â†’ è¿˜æ˜¯1ï¼ï¼ˆé”™äº†ï¼ï¼‰

å¦‚æœä¸è°ƒç”¨remove()ï¼Œæ—§æ•°æ®ä¼šä¸€ç›´å ç”¨å†…å­˜ï¼
```

**âœ… æ­£ç¡®åšæ³•ï¼šå¿…é¡»åœ¨è¯·æ±‚ç»“æŸåæ¸…ç†ï¼**

è®©æˆ‘æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ªé¡¹ç›®æœ‰æ²¡æœ‰åšï¼š 

æœç´¢æ–‡æœ¬ `afterCompletion` (`**/*.java`)ï¼Œæ— ç»“æœ

âŒ **ä¸¥é‡é—®é¢˜ï¼è¿™ä¸ªé¡¹ç›®çš„æ‹¦æˆªå™¨æ²¡æœ‰å®ç°afterCompletionæ–¹æ³•ï¼**

è¿™æ„å‘³ç€**ThreadLocalæ²¡æœ‰è¢«æ¸…ç†**ï¼Œå­˜åœ¨å†…å­˜æ³„æ¼é£é™©ï¼

è®©æˆ‘æ£€æŸ¥ä¸€ä¸‹å®Œæ•´çš„æ‹¦æˆªå™¨ä»£ç ï¼š 

è¯»å– [](file:///c%3A/_01_Code/My_Java/sky-take-out/sky-take-out/sky-server/src/main/java/com/sky/interceptor/JwtTokenAdminInterceptor.java)

æœç„¶ï¼**åªæœ‰preHandleï¼Œæ²¡æœ‰afterCompletion**ï¼

è¿™æ˜¯ä¸€ä¸ª**ä¸¥é‡çš„ä»£ç ç¼ºé™·**ï¼åœ¨é¢è¯•ä¸­å¦‚æœä½ èƒ½æŒ‡å‡ºè¿™ä¸ªé—®é¢˜ï¼Œä¼šå¤§å¤§åŠ åˆ†ï¼

è®©æˆ‘ç»™ä½ æ¼”ç¤ºæ­£ç¡®çš„å®ç°ï¼š 

Using "æ›¿æ¢æ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸²"


```

```
åŒæ ·çš„é—®é¢˜ï¼Œç”¨æˆ·ç«¯æ‹¦æˆªå™¨ä¹Ÿéœ€è¦ä¿®å¤ï¼š 

è¯»å– [](file:///c%3A/_01_Code/My_Java/sky-take-out/sky-take-out/sky-server/src/main/java/com/sky/interceptor/JwtTokenUserInterceptor.java)

Using "æ›¿æ¢æ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸²"


```

```
å¤ªå¥½äº†ï¼ç°åœ¨ä»£ç æ›´ä¸¥è°¨äº†ã€‚è®©æˆ‘æ€»ç»“ä¸€ä¸‹ä¿®å¤çš„é—®é¢˜ï¼š

---

## ğŸ”§ ä»£ç ç¼ºé™·ä¿®å¤æ€»ç»“

### âŒ åŸæ¥çš„é—®é¢˜ï¼š

```java
// åªæœ‰preHandleï¼Œæ²¡æœ‰æ¸…ç†
public boolean preHandle(...) {
    BaseContext.setCurrentId(empId);  // å­˜å…¥ThreadLocal
    return true;
}
// âš ï¸ è¯·æ±‚ç»“æŸåï¼ŒThreadLocalæ²¡æœ‰è¢«æ¸…ç†ï¼
```

### âœ… ä¿®å¤åï¼š

```java
// preHandleï¼šå­˜å…¥æ•°æ®
public boolean preHandle(...) {
    BaseContext.setCurrentId(empId);
    return true;
}

// afterCompletionï¼šæ¸…ç†æ•°æ®ï¼ˆæ–°å¢ï¼ï¼‰
@Override
public void afterCompletion(...) {
    BaseContext.removeCurrentId();  // å¿…é¡»æ¸…ç†ï¼
}
```

### ğŸ“Š æ‹¦æˆªå™¨ä¸‰ä¸ªæ–¹æ³•çš„æ‰§è¡Œæ—¶æœºï¼š

```mermaid
graph LR
    A[è¯·æ±‚åˆ°è¾¾] --> B[preHandle]
    B -->|return true| C[Controlleræ‰§è¡Œ]
    C --> D[postHandle]
    D --> E[è§†å›¾æ¸²æŸ“]
    E --> F[afterCompletion]
    F --> G[å“åº”è¿”å›]
    
    B -->|return false| H[ç›´æ¥è¿”å›]
    
    style F fill:#ff9999
```

```java
public interface HandlerInterceptor {
    
    // â‘  preHandleï¼šControlleræ‰§è¡Œå‰
    // è¿”å›trueæ”¾è¡Œï¼Œè¿”å›falseæ‹¦æˆª
    default boolean preHandle(HttpServletRequest request, 
                             HttpServletResponse response, 
                             Object handler) throws Exception {
        return true;
    }

    // â‘¡ postHandleï¼šControlleræ‰§è¡Œåï¼Œè§†å›¾æ¸²æŸ“å‰
    // å¯ä»¥ä¿®æ”¹ModelAndView
    default void postHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler, 
                           @Nullable ModelAndView modelAndView) throws Exception {
    }

    // â‘¢ afterCompletionï¼šæ•´ä¸ªè¯·æ±‚å®Œæˆåï¼ˆå¿…å®šæ‰§è¡Œï¼ï¼‰
    // â­ ç”¨äºèµ„æºæ¸…ç†ï¼ˆå…³é—­æµã€æ¸…ç†ThreadLocalç­‰ï¼‰
    default void afterCompletion(HttpServletRequest request, 
                                HttpServletResponse response, 
                                Object handler, 
                                @Nullable Exception ex) throws Exception {
    }
}
```

---

## ğŸ“ æœ€ç»ˆæ€»ç»“ï¼šç™»å½•è®¤è¯æ¨¡å—å®Œæ•´æµç¨‹

è®©æˆ‘ç”¨ä¸€å¼ æœ€ç»ˆçš„æµç¨‹å›¾æ€»ç»“æ‰€æœ‰çŸ¥è¯†ç‚¹ï¼š

```mermaid
sequenceDiagram
    autonumber
    participant å‰ç«¯
    participant Controller
    participant Interceptor as æ‹¦æˆªå™¨
    participant Service
    participant Mapper
    participant DB as æ•°æ®åº“
    participant JWT as JWTå·¥å…·
    participant TL as ThreadLocal
    
    rect rgb(255, 230, 230)
        Note over å‰ç«¯,TL: ã€åœºæ™¯ä¸€ï¼šç™»å½•ã€‘ä¸ç»è¿‡æ‹¦æˆªå™¨
        å‰ç«¯->>Controller: POST /admin/employee/login<br/>{username:"admin", password:"123456"}
        Note over Controller: DTOæ¥æ”¶å‚æ•°ï¼Œé˜²æ­¢å‚æ•°æ±¡æŸ“
        Controller->>Service: login(employeeLoginDTO)
        Service->>Mapper: getByUsername("admin")
        Note over Mapper: MyBatisåŠ¨æ€ä»£ç†
        Mapper->>DB: SELECT * FROM employee WHERE username='admin'
        DB-->>Mapper: æŸ¥è¯¢ç»“æœ
        Mapper-->>Service: Employeeå¯¹è±¡
        Service->>Service: â‘  è´¦å·å­˜åœ¨ï¼Ÿ<br/>â‘¡ MD5å¯†ç æ¯”å¯¹<br/>â‘¢ è´¦å·æœªé”å®šï¼Ÿ
        Service-->>Controller: è¿”å›Employeeå®ä½“
        Controller->>JWT: createJWT(secretKey, ttl, {empId:1})
        JWT-->>Controller: tokenå­—ç¬¦ä¸²
        Note over Controller: VOè¿”å›æ•°æ®ï¼Œé˜²æ­¢å¯†ç æ³„éœ²
        Controller-->>å‰ç«¯: {id, userName, name, token}
    end
    
    rect rgb(230, 255, 230)
        Note over å‰ç«¯,TL: ã€åœºæ™¯äºŒï¼šè®¿é—®èµ„æºã€‘ç»è¿‡æ‹¦æˆªå™¨
        å‰ç«¯->>Interceptor: GET /admin/dish/page<br/>Header: token=xxx
        Interceptor->>Interceptor: â‘  é™æ€èµ„æºï¼Ÿç›´æ¥æ”¾è¡Œ
        Interceptor->>JWT: parseJWT(secretKey, token)
        JWT-->>Interceptor: Claims{empId:1, exp:...}
        Interceptor->>TL: setCurrentId(1)
        Note over TL: å­˜å…¥å½“å‰çº¿ç¨‹çš„Map
        Interceptor->>Controller: æ”¾è¡Œ
        Controller->>Service: å¤„ç†ä¸šåŠ¡
        Service->>TL: getCurrentId()
        TL-->>Service: empId=1
        Note over TL: ä»å½“å‰çº¿ç¨‹çš„Mapå–å‡º
        Service-->>Controller: ä¸šåŠ¡æ•°æ®
        Controller-->>Interceptor: è¿”å›å“åº”
        Interceptor->>TL: removeCurrentId()
        Note over TL: âš ï¸æ¸…ç†ï¼é˜²æ­¢å†…å­˜æ³„æ¼
        Interceptor-->>å‰ç«¯: å“åº”ç»“æœ
    end
```

---

## ğŸ“ é¢è¯•å…«è‚¡æ–‡å¿…èƒŒæ¸…å•

### 1. DTO/Entity/VOçš„åŒºåˆ«ï¼Ÿ
```
DTOï¼šå‰ç«¯â†’åç«¯ï¼Œåªæ¥æ”¶éœ€è¦çš„å­—æ®µï¼Œé˜²æ­¢å‚æ•°æ±¡æŸ“
Entityï¼šæ•°æ®åº“æ˜ å°„ï¼ŒåŒ…å«æ‰€æœ‰å­—æ®µ
VOï¼šåç«¯â†’å‰ç«¯ï¼Œåªè¿”å›å®‰å…¨å­—æ®µï¼Œé˜²æ­¢ä¿¡æ¯æ³„éœ²
```

### 2. MyBatisçš„Mapperæ¥å£æ²¡æœ‰å®ç°ç±»ï¼Œä¸ºä»€ä¹ˆèƒ½æ‰§è¡Œï¼Ÿ
```
åŠ¨æ€ä»£ç†ï¼
MyBatisä¸ºMapperæ¥å£ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œ
è°ƒç”¨æ–¹æ³•æ—¶å»XMLä¸­æ‰¾å¯¹åº”çš„SQLæ‰§è¡Œã€‚
```

### 3. JWTçš„ä¸‰éƒ¨åˆ†æ˜¯ä»€ä¹ˆï¼Ÿ
```
Header.Payload.Signature
å¤´éƒ¨    è½½è·     ç­¾å

Payloadåªæ˜¯Base64ç¼–ç ï¼Œä¸æ˜¯åŠ å¯†ï¼
ä»»ä½•äººéƒ½èƒ½è§£ç ï¼Œæ‰€ä»¥ä¸èƒ½æ”¾å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯ï¼
```

### 4. JWTå’ŒSessionçš„åŒºåˆ«ï¼Ÿ
```
å­˜å‚¨ä½ç½®ï¼šSessionåœ¨æœåŠ¡ç«¯ï¼ŒJWTåœ¨å®¢æˆ·ç«¯
åˆ†å¸ƒå¼ï¼šSessionéœ€è¦å…±äº«ï¼ŒJWTå¤©ç„¶æ”¯æŒ
æ€§èƒ½ï¼šSessionéœ€è¦æŸ¥è¯¢ï¼ŒJWTç›´æ¥è§£æ
```

### 5. ThreadLocalåŸç†ï¼Ÿ
```
æ¯ä¸ªThreadå¯¹è±¡å†…éƒ¨æœ‰ä¸€ä¸ªThreadLocalMapï¼Œ
ä»¥ThreadLocalå¯¹è±¡ä¸ºkeyå­˜å‚¨å€¼ï¼Œ
æ¯ä¸ªçº¿ç¨‹è®¿é—®è‡ªå·±çš„Mapï¼Œå®ç°çº¿ç¨‹éš”ç¦»ã€‚
```

### 6. ThreadLocalä¸ºä»€ä¹ˆä¼šå†…å­˜æ³„æ¼ï¼Ÿ
```
ThreadLocalMapçš„Entryæ˜¯å¼±å¼•ç”¨ï¼Œ
keyè¢«å›æ”¶åå˜æˆnullï¼Œä½†valueè¿˜åœ¨ï¼Œ
å¦‚æœçº¿ç¨‹é•¿æœŸå­˜æ´»ï¼ˆçº¿ç¨‹æ± ï¼‰ï¼Œvalueæ°¸è¿œä¸ä¼šè¢«å›æ”¶ã€‚

è§£å†³ï¼šç”¨å®Œå¿…é¡»è°ƒç”¨remove()ï¼
```

### 7. æ‹¦æˆªå™¨çš„ä¸‰ä¸ªæ–¹æ³•ï¼Ÿ
```
preHandleï¼šæ‰§è¡Œå‰ï¼Œè¿”å›falseæ‹¦æˆª
postHandleï¼šæ‰§è¡Œåï¼Œè§†å›¾æ¸²æŸ“å‰
afterCompletionï¼šè¯·æ±‚å®Œæˆåï¼Œç”¨äºæ¸…ç†èµ„æº
```

### 8. MD5ä¸ºä»€ä¹ˆä¸å®‰å…¨ï¼Ÿå¦‚ä½•æ”¹è¿›ï¼Ÿ
```
MD5ï¼šå›ºå®šè¾“å…¥å›ºå®šè¾“å‡ºï¼Œå¯è¢«å½©è™¹è¡¨ç ´è§£
BCryptï¼šè‡ªå¸¦éšæœºç›ï¼Œæ¯æ¬¡ç»“æœä¸åŒï¼ŒæŠ—æš´åŠ›ç ´è§£
```

---

## ğŸ¯ ä½ ç°åœ¨éœ€è¦åšçš„

1. **é‡æ–°ç†è§£æµç¨‹**ï¼šç™»å½•ä¸ç»è¿‡æ‹¦æˆªå™¨ï¼Œåç»­è¯·æ±‚æ‰ç»è¿‡æ‹¦æˆªå™¨
2. **ç†è§£DTO/VOçš„æ„ä¹‰**ï¼šå‚æ•°æ±¡æŸ“å’Œä¿¡æ¯æ³„éœ²çš„é˜²æŠ¤
3. **æŒæ¡MyBatisåŸç†**ï¼šåŠ¨æ€ä»£ç†ç”Ÿæˆå®ç°ç±»
4. **ç†è§£JWTç”Ÿæˆå’Œè§£æ**ï¼šè½½è·æ˜¯æ˜æ–‡çš„ï¼Œç­¾åé˜²ç¯¡æ”¹
5. **åƒé€ThreadLocal**ï¼šçº¿ç¨‹éš”ç¦»åŸç†ã€å†…å­˜æ³„æ¼ã€å¦‚ä½•æ¸…ç†

**ç°åœ¨ç»™ä½ ä¸€é“é¢è¯•é¢˜æµ‹è¯•ï¼š**

> "å¦‚æœä¸¤ä¸ªç”¨æˆ·åŒæ—¶ç™»å½•ï¼Œç”¨æˆ·Açš„empIdæ˜¯1ï¼Œç”¨æˆ·Bçš„empIdæ˜¯2ï¼Œä»–ä»¬åŒæ—¶è®¿é—®/admin/dish/pageï¼Œè¯·è¯¦ç»†è¯´æ˜ThreadLocalå¦‚ä½•ä¿è¯ä»–ä»¬æ‹¿åˆ°çš„empIdä¸ä¼šæ··ä¹±ï¼Ÿåº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"

ä½ ç°åœ¨èƒ½å®Œæ•´å›ç­”äº†å—ï¼Ÿè¯•è¯•çœ‹ï¼ğŸ¤

Made changes.