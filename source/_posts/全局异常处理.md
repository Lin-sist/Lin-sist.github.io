---
title: å…¨å±€å¼‚å¸¸å¤„ç†
tags: [è‹ç©¹å¤–å–]
date: 
---


# ğŸ¯ ç¬¬ä¸€éƒ¨åˆ†ï¼šå…¨å±€å¼‚å¸¸å¤„ç†å™¨åœ¨å“ªé‡Œï¼Ÿ

## æ ¸å¿ƒç±»ï¼šGlobalExceptionHandler

**æ–‡ä»¶ä½ç½®ï¼š** GlobalExceptionHandler.java

```java
@RestControllerAdvice  // ğŸ”¥ æ ¸å¿ƒæ³¨è§£ï¼šå…¨å±€æ§åˆ¶å™¨å¢å¼º
@Slf4j
public class GlobalExceptionHandler {
    
    /**
     * æ•è·ä¸šåŠ¡å¼‚å¸¸ï¼ˆè‡ªå®šä¹‰å¼‚å¸¸ï¼‰
     */
    @ExceptionHandler  // ğŸ”¥ æ ‡è®°å¼‚å¸¸å¤„ç†æ–¹æ³•
    public Result exceptionHandler(BaseException ex) {
        log.error("å¼‚å¸¸ä¿¡æ¯ï¼š{}", ex.getMessage());
        return Result.error(ex.getMessage());
    }
    
    /**
     * æ•è·SQLçº¦æŸå¼‚å¸¸ï¼ˆå¦‚ç”¨æˆ·åé‡å¤ï¼‰
     */
    @ExceptionHandler
    public Result exceptionHandler(SQLIntegrityConstraintViolationException ex) {
        // Duplicate entry 'zhangsan' for key 'employee.idx_username'
        String message = ex.getMessage();
        if (message.contains("Duplicate entry")) {
            String[] split = message.split(" ");
            String username = split[2];
            String msg = username + MessageConstant.ALREADY_EXISTS;
            return Result.error(msg);
        } else {
            return Result.error(MessageConstant.UNKNOWN_ERROR);
        }
    }
}
```

---

# ğŸ—ï¸ ç¬¬äºŒéƒ¨åˆ†ï¼šé¡¹ç›®ä¸­æŠ›å‡ºå¼‚å¸¸çš„å®Œæ•´é“¾è·¯

## ä¸€ã€å¼‚å¸¸ä½“ç³»ç»“æ„

```mermaid
graph TB
    RuntimeException[RuntimeException]
    RuntimeException --> BaseException[BaseException ä¸šåŠ¡å¼‚å¸¸åŸºç±»]
    
    BaseException --> AccountNotFoundException[AccountNotFoundException<br/>è´¦å·ä¸å­˜åœ¨]
    BaseException --> PasswordErrorException[PasswordErrorException<br/>å¯†ç é”™è¯¯]
    BaseException --> AccountLockedException[AccountLockedException<br/>è´¦å·è¢«é”å®š]
    BaseException --> DeletionNotAllowedException[DeletionNotAllowedException<br/>ä¸å…è®¸åˆ é™¤]
    BaseException --> ShoppingCartBusinessException[ShoppingCartBusinessException<br/>è´­ç‰©è½¦ä¸šåŠ¡å¼‚å¸¸]
    BaseException --> AddressBookBusinessException[AddressBookBusinessException<br/>åœ°å€ç°¿å¼‚å¸¸]
    BaseException --> OrderBusinessException[OrderBusinessException<br/>è®¢å•ä¸šåŠ¡å¼‚å¸¸]
    
    style BaseException fill:#FFE4B5
    style AccountNotFoundException fill:#90EE90
    style PasswordErrorException fill:#90EE90
    style OrderBusinessException fill:#90EE90
```

**æ‰€æœ‰è‡ªå®šä¹‰å¼‚å¸¸éƒ½åœ¨è¿™é‡Œï¼š** exception

---

## äºŒã€å…¸å‹åº”ç”¨åœºæ™¯ï¼ˆå¸¦å®Œæ•´æµç¨‹ï¼‰

### åœºæ™¯1ï¸âƒ£ï¼šå‘˜å·¥ç™»å½•ï¼ˆæœ€ç»å…¸ï¼‰

**å®Œæ•´æµç¨‹å›¾ï¼š**

```mermaid
sequenceDiagram
    participant å‰ç«¯
    participant Controller
    participant Service
    participant å¼‚å¸¸å¤„ç†å™¨
    
    å‰ç«¯->>Controller: POST /admin/employee/login<br/>{username:"admin",password:"wrong"}
    Controller->>Service: employeeService.login(dto)
    
    alt è´¦å·ä¸å­˜åœ¨
        Service->>Service: employee == null
        Service-->>å¼‚å¸¸å¤„ç†å™¨: throw AccountNotFoundException
        å¼‚å¸¸å¤„ç†å™¨-->>å‰ç«¯: {code:0, msg:"è´¦å·ä¸å­˜åœ¨"}
    else å¯†ç é”™è¯¯
        Service->>Service: passwordä¸åŒ¹é…
        Service-->>å¼‚å¸¸å¤„ç†å™¨: throw PasswordErrorException
        å¼‚å¸¸å¤„ç†å™¨-->>å‰ç«¯: {code:0, msg:"å¯†ç é”™è¯¯"}
    else è´¦å·è¢«é”å®š
        Service->>Service: status == DISABLE
        Service-->>å¼‚å¸¸å¤„ç†å™¨: throw AccountLockedException
        å¼‚å¸¸å¤„ç†å™¨-->>å‰ç«¯: {code:0, msg:"è´¦å·è¢«é”å®š"}
    else æˆåŠŸ
        Service-->>Controller: è¿”å›Employeeå¯¹è±¡
        Controller-->>å‰ç«¯: {code:1, data:{...}}
    end
```

**ä»£ç å®ç°ï¼š**

**â‘  Serviceå±‚æŠ›å‡ºå¼‚å¸¸** - EmployeeServiceImpl.java

```java
@Service
public class EmployeeServiceImpl implements EmployeeService {
    
    public Employee login(EmployeeLoginDTO employeeLoginDTO) {
        String username = employeeLoginDTO.getUsername();
        String password = employeeLoginDTO.getPassword();
        
        // 1. æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢
        Employee employee = employeeMapper.getByUsername(username);
        
        // 2. å¤„ç†å¼‚å¸¸æƒ…å†µ ğŸ”¥
        if (employee == null) {
            // æŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸
            throw new AccountNotFoundException(MessageConstant.ACCOUNT_NOT_FOUND);
        }
        
        // å¯†ç æ¯”å¯¹
        password = DigestUtils.md5DigestAsHex(password.getBytes());
        if (!password.equals(employee.getPassword())) {
            throw new PasswordErrorException(MessageConstant.PASSWORD_ERROR);
        }
        
        if (employee.getStatus() == StatusConstant.DISABLE) {
            throw new AccountLockedException(MessageConstant.ACCOUNT_LOCKED);
        }
        
        // 3. è¿”å›å®ä½“å¯¹è±¡
        return employee;
    }
}
```

**â‘¡ Controllerå±‚è°ƒç”¨** - EmployeeController.java

```java
@RestController
@RequestMapping("/admin/employee")
public class EmployeeController {
    
    @PostMapping("/login")
    public Result<EmployeeLoginVO> login(@RequestBody EmployeeLoginDTO dto) {
        log.info("å‘˜å·¥ç™»å½•ï¼š{}", dto);
        
        // âœ… ä¸éœ€è¦ try-catchï¼Œå¼‚å¸¸ä¼šè¢«å…¨å±€å¤„ç†å™¨æ•è·
        Employee employee = employeeService.login(dto);
        
        // ç”ŸæˆJWT Token
        String token = JwtUtil.createJWT(...);
        
        return Result.success(employeeLoginVO);
    }
}
```

**â‘¢ å…¨å±€å¼‚å¸¸å¤„ç†å™¨æ•è·** 

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler
    public Result exceptionHandler(BaseException ex) {
        log.error("å¼‚å¸¸ä¿¡æ¯ï¼š{}", ex.getMessage());
        // ç»Ÿä¸€æ ¼å¼ï¼š{code: 0, msg: "è´¦å·ä¸å­˜åœ¨"}
        return Result.error(ex.getMessage());
    }
}
```

---

### åœºæ™¯2ï¸âƒ£ï¼šèœå“åˆ é™¤ï¼ˆä¸šåŠ¡é€»è¾‘æ ¡éªŒï¼‰

**æ–‡ä»¶ï¼š** DishServiceImpl.java

```java
@Service
public class DishServiceImpl implements DishService {
    
    @Override
    @Transactional
    public void deleteBatch(List<Long> ids) {
        // åˆ¤æ–­å½“å‰èœå“æ˜¯å¦èƒ½å¤Ÿåˆ é™¤ - æ˜¯å¦å­˜åœ¨èµ·å”®ä¸­çš„èœå“ï¼Ÿ
        ids.forEach(id -> {
            Dish dish = dishMapper.getById(id);
            if (dish.getStatus() == StatusConstant.ENABLE) {
                // ğŸ”¥ èµ·å”®ä¸­çš„èœå“ä¸èƒ½åˆ é™¤
                throw new DeletionNotAllowedException(MessageConstant.DISH_ON_SALE);
            }
        });
        
        // åˆ¤æ–­å½“å‰èœå“æ˜¯å¦èƒ½å¤Ÿåˆ é™¤ - æ˜¯å¦è¢«å¥—é¤å…³è”äº†ï¼Ÿ
        List<Long> setmealIds = setmealDishMapper.getSetmealIdsByDishIds(ids);
        if (setmealIds != null && setmealIds.size() > 0) {
            // ğŸ”¥ è¢«å¥—é¤å…³è”çš„èœå“ä¸èƒ½åˆ é™¤
            throw new DeletionNotAllowedException(MessageConstant.DISH_BE_RELATED_BY_SETMEAL);
        }
        
        // åˆ é™¤èœå“æ•°æ®
        ids.forEach(id -> {
            dishMapper.deleteById(id);
            dishFlavorMapper.deleteByDishId(id);
        });
    }
}
```

---

### åœºæ™¯3ï¸âƒ£ï¼šç”¨æˆ·ä¸‹å•ï¼ˆå¤šé‡æ ¡éªŒï¼‰

**æ–‡ä»¶ï¼š** OrderServiceImpl.java

```java
@Service
public class OrderServiceImpl implements OrderService {
    
    @Override
    public OrderSubmitVO submitOrder(OrdersSubmitDTO ordersSubmitDTO) {
        // 1. å¼‚å¸¸æƒ…å†µçš„å¤„ç† - æ”¶è´§åœ°å€ä¸ºç©º
        AddressBook addressBook = addressBookMapper.getById(ordersSubmitDTO.getAddressBookId());
        if (addressBook == null) {
            throw new AddressBookBusinessException(MessageConstant.ADDRESS_BOOK_IS_NULL);
        }
        
        // 2. æ£€æŸ¥ç”¨æˆ·çš„æ”¶è´§åœ°å€æ˜¯å¦è¶…å‡ºé…é€èŒƒå›´
        checkOutOfRange(addressBook.getCityName() + addressBook.getDistrictName() + addressBook.getDetail());
        
        // 3. æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„è´­ç‰©è½¦æ•°æ®
        List<ShoppingCart> shoppingCartList = shoppingCartMapper.list(shoppingCart);
        if (shoppingCartList == null || shoppingCartList.size() == 0) {
            throw new ShoppingCartBusinessException(MessageConstant.SHOPPING_CART_IS_NULL);
        }
        
        // æ„é€ è®¢å•æ•°æ®...
    }
}
```

---

### åœºæ™¯4ï¸âƒ£ï¼šSQLçº¦æŸå¼‚å¸¸ï¼ˆç”¨æˆ·åé‡å¤ï¼‰

**æµç¨‹ï¼š**

```mermaid
graph LR
    A[æ–°å¢å‘˜å·¥] --> B[usernameå·²å­˜åœ¨]
    B --> C[MySQLæŠ›å‡ºSQLIntegrityConstraintViolationException]
    C --> D[å…¨å±€å¼‚å¸¸å¤„ç†å™¨æ•è·]
    D --> E[è§£æé”™è¯¯ä¿¡æ¯]
    E --> F[è¿”å›: zhangsanå·²å­˜åœ¨]
```

**ä»£ç ï¼š** GlobalExceptionHandler.java

```java
@ExceptionHandler
public Result exceptionHandler(SQLIntegrityConstraintViolationException ex) {
    // åŸå§‹é”™è¯¯ï¼šDuplicate entry 'zhangsan' for key 'employee.idx_username'
    String message = ex.getMessage();
    
    if (message.contains("Duplicate entry")) {
        // æå–ç”¨æˆ·åï¼š"zhangsan"
        String[] split = message.split(" ");
        String username = split[2];
        
        // ğŸ”¥ å‹å¥½çš„é”™è¯¯ä¿¡æ¯ï¼šzhangsanå·²å­˜åœ¨
        String msg = username + MessageConstant.ALREADY_EXISTS;
        return Result.error(msg);
    } else {
        return Result.error(MessageConstant.UNKNOWN_ERROR);
    }
}
```

---

## ä¸‰ã€é¡¹ç›®ä¸­æŠ›å‡ºå¼‚å¸¸çš„ç»Ÿè®¡

æ ¹æ®æˆ‘çš„ä»£ç æ‰«æï¼Œé¡¹ç›®ä¸­å…±æœ‰**20+å¤„**æŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸ï¼š

| Serviceç±» | æŠ›å‡ºå¼‚å¸¸æ•°é‡ | ä¸»è¦åœºæ™¯ |
|-----------|-------------|---------|
| `EmployeeServiceImpl` | 3å¤„ | ç™»å½•æ ¡éªŒï¼ˆè´¦å·ä¸å­˜åœ¨ã€å¯†ç é”™è¯¯ã€è´¦å·é”å®šï¼‰ |
| `OrderServiceImpl` | 8å¤„ | ä¸‹å•æ ¡éªŒï¼ˆåœ°å€ä¸ºç©ºã€è´­ç‰©è½¦ç©ºã€è®¢å•çŠ¶æ€é”™è¯¯ç­‰ï¼‰ |
| `DishServiceImpl` | 2å¤„ | èœå“åˆ é™¤æ ¡éªŒï¼ˆèµ·å”®ä¸­ã€è¢«å¥—é¤å…³è”ï¼‰ |
| `CategoryServiceImpl` | 2å¤„ | åˆ†ç±»åˆ é™¤æ ¡éªŒï¼ˆå…³è”èœå“ã€å…³è”å¥—é¤ï¼‰ |
| `SetmealServiceImpl` | è‹¥å¹²å¤„ | å¥—é¤ç›¸å…³ä¸šåŠ¡æ ¡éªŒ |

---

# âŒ ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¦‚æœæ²¡æœ‰å…¨å±€å¼‚å¸¸å¤„ç†ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

## ä¸€ã€æ²¡æœ‰å…¨å±€å¼‚å¸¸å¤„ç†å™¨çš„ä»£ç ï¼ˆå™©æ¢¦ï¼‰

### æ–¹æ¡ˆ1ï¼šæ¯ä¸ªControlleréƒ½try-catchï¼ˆä»£ç è‡ƒè‚¿ï¼‰

```java
@PostMapping("/login")
public Result login(@RequestBody EmployeeLoginDTO dto) {
    try {
        Employee employee = employeeService.login(dto);
        return Result.success(employeeLoginVO);
        
    } catch (AccountNotFoundException e) {
        return Result.error("è´¦å·ä¸å­˜åœ¨");
        
    } catch (PasswordErrorException e) {
        return Result.error("å¯†ç é”™è¯¯");
        
    } catch (AccountLockedException e) {
        return Result.error("è´¦å·è¢«é”å®š");
        
    } catch (Exception e) {
        return Result.error("ç³»ç»Ÿå¼‚å¸¸");
    }
}

// âŒ é—®é¢˜ï¼š
// 1. æ¯ä¸ªæ¥å£éƒ½è¦å†™ä¸€é try-catch
// 2. ä»£ç é‡å¤ï¼Œéš¾ä»¥ç»´æŠ¤
// 3. å®¹æ˜“é—æ¼å¼‚å¸¸å¤„ç†
```

### æ–¹æ¡ˆ2ï¼šä¸å¤„ç†å¼‚å¸¸ï¼ˆç”¨æˆ·ä½“éªŒæå·®ï¼‰

```java
@PostMapping("/login")
public Result login(@RequestBody EmployeeLoginDTO dto) {
    // ä¸æ•è·å¼‚å¸¸
    Employee employee = employeeService.login(dto);
    return Result.success(employeeLoginVO);
}

// âŒ å¦‚æœå¯†ç é”™è¯¯ï¼Œå‰ç«¯æ”¶åˆ°çš„å“åº”ï¼š
{
  "timestamp": "2026-02-15T10:30:00.000+00:00",
  "status": 500,
  "error": "Internal Server Error",
  "message": "å¯†ç é”™è¯¯",
  "path": "/admin/employee/login"
}

// å‰ç«¯æ— æ³•åˆ¤æ–­æ˜¯ä»€ä¹ˆç±»å‹çš„é”™è¯¯ï¼
```

---

## äºŒã€å¯¹æ¯”ï¼šæœ‰æ— å…¨å±€å¼‚å¸¸å¤„ç†

| å¯¹æ¯”é¡¹ | æ²¡æœ‰å…¨å±€å¼‚å¸¸å¤„ç† | æœ‰å…¨å±€å¼‚å¸¸å¤„ç† âœ… |
|--------|----------------|------------------|
| **ä»£ç é‡** | æ¯ä¸ªControlleréƒ½è¦try-catch | Controllerå¹²å‡€ç®€æ´ |
| **ç»´æŠ¤æ€§** | å¼‚å¸¸å¤„ç†é€»è¾‘åˆ†æ•£ï¼Œéš¾ä»¥ç»Ÿä¸€ä¿®æ”¹ | é›†ä¸­ç®¡ç†ï¼Œæ˜“äºç»´æŠ¤ |
| **å“åº”æ ¼å¼** | ä¸ç»Ÿä¸€ï¼Œæœ‰çš„æ˜¯Springé»˜è®¤æ ¼å¼ï¼Œæœ‰çš„æ˜¯è‡ªå®šä¹‰ | ç»Ÿä¸€æ ¼å¼ `Result` |
| **æ—¥å¿—è®°å½•** | å¯èƒ½é—æ¼ | ç»Ÿä¸€è®°å½•åˆ°æ—¥å¿— |
| **å‰ç«¯å¤„ç†** | éœ€è¦åˆ¤æ–­å¤šç§å“åº”æ ¼å¼ | åªéœ€åˆ¤æ–­ `code` å­—æ®µ |

---

## ä¸‰ã€å…·ä½“å½±å“ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šç™»å½•å¤±è´¥

**âŒ æ²¡æœ‰å…¨å±€å¼‚å¸¸å¤„ç†ï¼ˆSpringé»˜è®¤å“åº”ï¼‰ï¼š**
```json
{
  "timestamp": "2026-02-15T10:30:00.000+00:00",
  "status": 500,
  "error": "Internal Server Error",
  "message": "è´¦å·ä¸å­˜åœ¨",
  "path": "/admin/employee/login"
}
```

**âœ… æœ‰å…¨å±€å¼‚å¸¸å¤„ç†ï¼ˆç»Ÿä¸€æ ¼å¼ï¼‰ï¼š**
```json
{
  "code": 0,
  "msg": "è´¦å·ä¸å­˜åœ¨",
  "data": null
}
```

**å‰ç«¯ä»£ç å¯¹æ¯”ï¼š**

```javascript
// âŒ æ²¡æœ‰å…¨å±€å¼‚å¸¸å¤„ç† - å‰ç«¯éœ€è¦åˆ¤æ–­å¤šç§æƒ…å†µ
axios.post('/login', data).then(res => {
    if (res.status === 200 && res.data.code === 1) {
        // æˆåŠŸ
    } else if (res.status === 500) {
        // æœåŠ¡å™¨é”™è¯¯
    } else {
        // å…¶ä»–æƒ…å†µ
    }
}).catch(err => {
    // è¿˜è¦å¤„ç†ç½‘ç»œé”™è¯¯
});

// âœ… æœ‰å…¨å±€å¼‚å¸¸å¤„ç† - å‰ç«¯åªéœ€åˆ¤æ–­ code
axios.post('/login', data).then(res => {
    if (res.data.code === 1) {
        // æˆåŠŸ
        console.log(res.data.data);
    } else {
        // å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        alert(res.data.msg);
    }
});
```

---

### ç¤ºä¾‹2ï¼šåˆ é™¤èœå“

**ä¸šåŠ¡åœºæ™¯ï¼š** åˆ é™¤ä¸€ä¸ªèµ·å”®ä¸­çš„èœå“

**âŒ æ²¡æœ‰å…¨å±€å¼‚å¸¸å¤„ç†ï¼š**
```
åç«¯æ—¥å¿—ï¼š
Exception in thread "http-nio-8080-exec-1" com.sky.exception.DeletionNotAllowedException: èµ·å”®ä¸­çš„èœå“ä¸èƒ½åˆ é™¤
    at com.sky.service.impl.DishServiceImpl.deleteBatch(DishServiceImpl.java:92)
    ...

å‰ç«¯æ”¶åˆ°ï¼š
HTTP 500 Internal Server Error
{
  "timestamp": "2026-02-15T10:30:00",
  "status": 500,
  "error": "Internal Server Error",
  "message": "",
  "path": "/admin/dish"
}

ç”¨æˆ·çœ‹åˆ°ï¼šæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜
```

**âœ… æœ‰å…¨å±€å¼‚å¸¸å¤„ç†ï¼š**
```
åç«¯æ—¥å¿—ï¼š
2026-02-15 10:30:00.123 ERROR [GlobalExceptionHandler] å¼‚å¸¸ä¿¡æ¯ï¼šèµ·å”®ä¸­çš„èœå“ä¸èƒ½åˆ é™¤

å‰ç«¯æ”¶åˆ°ï¼š
{
  "code": 0,
  "msg": "èµ·å”®ä¸­çš„èœå“ä¸èƒ½åˆ é™¤",
  "data": null
}

ç”¨æˆ·çœ‹åˆ°ï¼šèµ·å”®ä¸­çš„èœå“ä¸èƒ½åˆ é™¤ï¼ˆå‹å¥½çš„ä¸šåŠ¡æç¤ºï¼‰
```

---

# ğŸ“ ç¬¬å››éƒ¨åˆ†ï¼šæ ¸å¿ƒæ³¨è§£è¯¦è§£

## `@RestControllerAdvice`

**ä½œç”¨ï¼š** å…¨å±€æ§åˆ¶å™¨å¢å¼º + è‡ªåŠ¨è½¬JSON

**ç»„æˆï¼š**
```java
@RestControllerAdvice 
= @ControllerAdvice  // æ§åˆ¶å™¨å¢å¼º
+ @ResponseBody       // è¿”å›å€¼è½¬JSON
```

**æ‰«æèŒƒå›´ï¼š** é»˜è®¤æ‰«ææ‰€æœ‰`@Controller`å’Œ`@RestController`

**å¯ä»¥æŒ‡å®šèŒƒå›´ï¼š**
```java
@RestControllerAdvice(basePackages = "com.sky.controller")  // åªæ‰«æè¿™ä¸ªåŒ…
@RestControllerAdvice(assignableTypes = {EmployeeController.class})  // åªé’ˆå¯¹æŸäº›Controller
```

---

## `@ExceptionHandler`

**ä½œç”¨ï¼š** æ ‡è®°å¼‚å¸¸å¤„ç†æ–¹æ³•

**åŒ¹é…è§„åˆ™ï¼š**
1. **ç²¾ç¡®åŒ¹é…ä¼˜å…ˆ**ï¼šå…ˆæ‰¾èƒ½å¤„ç†è¯¥å¼‚å¸¸ç±»å‹çš„æ–¹æ³•
2. **çˆ¶ç±»åŒ¹é…**ï¼šå¦‚æœæ²¡æœ‰ï¼Œæ‰¾èƒ½å¤„ç†çˆ¶ç±»å¼‚å¸¸çš„æ–¹æ³•
3. **é€šç”¨åŒ¹é…**ï¼šéƒ½æ²¡æœ‰ï¼Œæ‰¾`Exception`ç±»å‹çš„å¤„ç†æ–¹æ³•

**ç¤ºä¾‹ï¼š**

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    // å¤„ç†è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸
    @ExceptionHandler(BaseException.class)
    public Result handleBusinessException(BaseException ex) {
        return Result.error(ex.getMessage());
    }
    
    // å¤„ç†SQLå¼‚å¸¸
    @ExceptionHandler(SQLIntegrityConstraintViolationException.class)
    public Result handleSQLException(SQLIntegrityConstraintViolationException ex) {
        // ç‰¹æ®Šå¤„ç†...
        return Result.error("æ•°æ®åº“æ“ä½œå¤±è´¥");
    }
    
    // å¤„ç†æ‰€æœ‰æœªè¢«æ•è·çš„å¼‚å¸¸ï¼ˆå…œåº•ï¼‰
    @ExceptionHandler(Exception.class)
    public Result handleException(Exception ex) {
        log.error("ç³»ç»Ÿå¼‚å¸¸", ex);
        return Result.error("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•");
    }
}
```

---

# ğŸ”¥ ç¬¬äº”éƒ¨åˆ†ï¼šé¢è¯•é«˜é¢‘è€ƒç‚¹

## â“ é¢è¯•é¢˜1ï¼šå…¨å±€å¼‚å¸¸å¤„ç†çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**ç­”ï¼ˆä¸‰æ®µå¼ï¼‰ï¼š**

**ç¬¬ä¸€æ®µ - åŸºäºAOPå®ç°ï¼š**
Springé€šè¿‡AOPæ‹¦æˆªæ‰€æœ‰Controlleræ–¹æ³•çš„æ‰§è¡Œï¼Œå½“æ–¹æ³•æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œä¼šè¢«`ExceptionHandlerExceptionResolver`æ•è·ã€‚

**ç¬¬äºŒæ®µ - åŒ¹é…å¤„ç†å™¨ï¼š**
æ ¹æ®å¼‚å¸¸ç±»å‹ï¼Œä»æ‰€æœ‰æ ‡æ³¨äº†`@ExceptionHandler`çš„æ–¹æ³•ä¸­æ‰¾åˆ°æœ€åŒ¹é…çš„å¤„ç†æ–¹æ³•ï¼Œç²¾ç¡®åŒ¹é…ä¼˜å…ˆï¼Œç„¶åæ˜¯çˆ¶ç±»åŒ¹é…ã€‚

**ç¬¬ä¸‰æ®µ - ç»Ÿä¸€å“åº”ï¼š**
æ‰§è¡Œå¤„ç†æ–¹æ³•ï¼Œè¿”å›ç»Ÿä¸€æ ¼å¼çš„`Result`å¯¹è±¡ï¼Œé¿å…äº†Springé»˜è®¤çš„é”™è¯¯å“åº”ã€‚

---

## â“ é¢è¯•é¢˜2ï¼š`@ControllerAdvice`å’Œ`@RestControllerAdvice`çš„åŒºåˆ«ï¼Ÿ

**ç­”ï¼š**

| æ³¨è§£ | è¿”å›å€¼å¤„ç† | ä½¿ç”¨åœºæ™¯ |
|------|-----------|---------|
| `@ControllerAdvice` | éœ€è¦æ‰‹åŠ¨åŠ `@ResponseBody` | è¿”å›è§†å›¾ |
| `@RestControllerAdvice` | è‡ªåŠ¨è½¬JSONï¼ˆå†…å«`@ResponseBody`ï¼‰ | è¿”å›JSONï¼ˆRESTful APIï¼‰|

```java
// @ControllerAdvice
@ControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BaseException.class)
    @ResponseBody  // éœ€è¦æ‰‹åŠ¨åŠ 
    public Result handleException(BaseException ex) {
        return Result.error(ex.getMessage());
    }
}

// @RestControllerAdviceï¼ˆæ¨èï¼‰
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BaseException.class)  // ä¸éœ€è¦@ResponseBody
    public Result handleException(BaseException ex) {
        return Result.error(ex.getMessage());
    }
}
```

---

## â“ é¢è¯•é¢˜3ï¼šå¦‚ä½•å¤„ç†å‚æ•°æ ¡éªŒå¼‚å¸¸ï¼Ÿ

**ç­”ï¼š** 

åœ¨é¡¹ç›®ä¸­å¯ä»¥æ‰©å±•å…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼Œå¢åŠ å¯¹`MethodArgumentNotValidException`çš„å¤„ç†ï¼š

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    // å¤„ç† @Validated æ ¡éªŒå¤±è´¥
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public Result handleValidException(MethodArgumentNotValidException ex) {
        // è·å–ç¬¬ä¸€ä¸ªæ ¡éªŒå¤±è´¥çš„é”™è¯¯ä¿¡æ¯
        String message = ex.getBindingResult()
                .getFieldError()
                .getDefaultMessage();
        return Result.error(message);
    }
}
```

---

## â“ é¢è¯•é¢˜4ï¼šä¸ºä»€ä¹ˆè‡ªå®šä¹‰å¼‚å¸¸è¦ç»§æ‰¿RuntimeExceptionï¼Ÿ

**ç­”ï¼š**

| å¼‚å¸¸ç±»å‹ | æ˜¯å¦å¿…é¡»æ•è· | äº‹åŠ¡å›æ»š |
|---------|------------|---------|
| `Exception`ï¼ˆå—æ£€å¼‚å¸¸ï¼‰ | å¿…é¡»try-catchæˆ–throws | **é»˜è®¤ä¸å›æ»š** |
| `RuntimeException`ï¼ˆéå—æ£€å¼‚å¸¸ï¼‰ | ä¸å¼ºåˆ¶æ•è· | **é»˜è®¤å›æ»š** |

```java
// âœ… ç»§æ‰¿ RuntimeExceptionï¼ˆæ¨èï¼‰
public class BaseException extends RuntimeException {
    public BaseException(String msg) {
        super(msg);
    }
}

// Serviceä¸­ç›´æ¥æŠ›å‡ºï¼Œä¸éœ€è¦throws
public void delete(Long id) {
    if (dish.getStatus() == ENABLE) {
        throw new DeletionNotAllowedException("èµ·å”®ä¸­çš„èœå“ä¸èƒ½åˆ é™¤");
        // äº‹åŠ¡è‡ªåŠ¨å›æ»š âœ…
    }
}

// âŒ ç»§æ‰¿ Exception
public class BaseException extends Exception {
    // ...
}

// Serviceä¸­å¿…é¡»å£°æ˜ throwsï¼Œéº»çƒ¦
public void delete(Long id) throws BaseException {
    if (dish.getStatus() == ENABLE) {
        throw new DeletionNotAllowedException("èµ·å”®ä¸­çš„èœå“ä¸èƒ½åˆ é™¤");
        // äº‹åŠ¡é»˜è®¤ä¸å›æ»šï¼éœ€è¦é…ç½® rollbackFor âŒ
    }
}
```

---

## â“ é¢è¯•é¢˜5ï¼šè¯´è¯´ä½ ä»¬é¡¹ç›®ä¸­çš„å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ

**ç­”ï¼ˆç»“åˆé¡¹ç›®å›ç­”ï¼‰ï¼š**

> "æˆ‘ä»¬é¡¹ç›®é‡‡ç”¨äº†åˆ†å±‚çš„å¼‚å¸¸å¤„ç†ç­–ç•¥ï¼š
> 
> **1. è‡ªå®šä¹‰å¼‚å¸¸ä½“ç³»**  
> å®šä¹‰äº†`BaseException`ä½œä¸ºæ‰€æœ‰ä¸šåŠ¡å¼‚å¸¸çš„çˆ¶ç±»ï¼Œé’ˆå¯¹ä¸åŒä¸šåŠ¡åœºæ™¯æ´¾ç”Ÿå‡º`AccountNotFoundException`ã€`OrderBusinessException`ç­‰å­ç±»ï¼Œè¯­ä¹‰æ¸…æ™°ã€‚
> 
> **2. å…¨å±€å¼‚å¸¸å¤„ç†å™¨**  
> ç”¨`@RestControllerAdvice`ç»Ÿä¸€æ•è·å¼‚å¸¸ï¼Œæ ¹æ®å¼‚å¸¸ç±»å‹è¿”å›ä¸åŒçš„é”™è¯¯ä¿¡æ¯ã€‚æ¯”å¦‚SQLçº¦æŸå¼‚å¸¸ä¼šè§£æå…·ä½“çš„å­—æ®µåï¼Œè¿”å›"xxxå·²å­˜åœ¨"ã€‚
> 
> **3. Serviceå±‚èŒè´£æ˜ç¡®**  
> Serviceå±‚ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘æ ¡éªŒï¼Œä¸ç¬¦åˆè§„åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚Controllerå±‚ä¸éœ€è¦ä»»ä½•try-catchï¼Œä»£ç éå¸¸ç®€æ´ã€‚
> 
> **4. ç»Ÿä¸€å“åº”æ ¼å¼**  
> æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½è¿”å›`Result`å¯¹è±¡ï¼Œå‰ç«¯åªéœ€åˆ¤æ–­`code`å­—æ®µï¼Œå¤§å¤§ç®€åŒ–äº†å‰ç«¯çš„é”™è¯¯å¤„ç†é€»è¾‘ã€‚
> 
> **5. æ—¥å¿—è®°å½•**  
> å…¨å±€å¼‚å¸¸å¤„ç†å™¨ä¸­ç»Ÿä¸€è®°å½•æ—¥å¿—ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜ã€‚"

---

# ğŸ“Š æ€»ç»“å¯¹æ¯”è¡¨

| å¯¹æ¯”é¡¹ | Controlleræ‰‹åŠ¨å¤„ç† | å…¨å±€å¼‚å¸¸å¤„ç† âœ… |
|--------|-------------------|----------------|
| **ä»£ç é‡** | æ¯ä¸ªæ–¹æ³•éƒ½è¦try-catch | Controlleré›¶é¢å¤–ä»£ç  |
| **å¯ç»´æŠ¤æ€§** | å¼‚å¸¸å¤„ç†é€»è¾‘åˆ†æ•£ | é›†ä¸­åœ¨GlobalExceptionHandler |
| **å“åº”æ ¼å¼** | å¯èƒ½ä¸ç»Ÿä¸€ | ç»Ÿä¸€Resultæ ¼å¼ |
| **æ—¥å¿—è®°å½•** | å®¹æ˜“é—æ¼ | ç»Ÿä¸€è®°å½• |
| **ä¸šåŠ¡åˆ†ç¦»** | ä¸šåŠ¡é€»è¾‘å’Œå¼‚å¸¸å¤„ç†æ··åœ¨ä¸€èµ· | èŒè´£æ¸…æ™°åˆ†ç¦» |
| **æ‰©å±•æ€§** | æ–°å¢å¼‚å¸¸ç±»å‹éœ€è¦æ”¹å¤šå¤„ | åªéœ€åœ¨Handlerä¸­åŠ ä¸€ä¸ªæ–¹æ³• |

---

**ç°åœ¨ä½ æƒ³ï¼š**
1. ğŸ”§ **å®æˆ˜ç»ƒä¹ ** - æ–°å¢ä¸€ä¸ªå¼‚å¸¸ç±»å‹ï¼ˆå¦‚ç”¨æˆ·ä½™é¢ä¸è¶³ï¼‰å¹¶å¤„ç†
2. ğŸ“š **æ·±å…¥å­¦ä¹ ** - å­¦ä¹ JWTç™»å½•è®¤è¯çš„å®Œæ•´æµç¨‹
3. ğŸ¯ **ä¸‹ä¸€ä¸ªçŸ¥è¯†ç‚¹** - å­¦ä¹ ç»Ÿä¸€å“åº”å°è£…Resultçš„è®¾è®¡

é€‰æ‹©ä½ çš„å­¦ä¹ è·¯å¾„ï¼ğŸ’ª

Similar code found with 1 license type